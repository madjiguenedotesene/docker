<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÆPrediction - Eurosmart Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        #correlation-plot {
            width: 100%; 
            height: 500px;
        }
        /* Style pour la modale */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        /* Badges de performance pour le guide */
        .perf-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }
        .perf-good { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; } /* Vert */
        .perf-avg { background-color: #fef3c7; color: #92400e; border: 1px solid #fcd34d; } /* Jaune */
        .perf-bad { background-color: #fee2e2; color: #b91c1c; border: 1px solid #f87171; } /* Rouge */

        
        /* Animation pour le chargement */
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-900">

    <nav class="fixed top-0 left-0 w-full z-10 p-4 bg-gray-900/90 backdrop-blur-md shadow-md">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center z-10">
                 <img src="static/images/logo.png" alt="Logo Eurosmart Analytics" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end z-10">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>


    <main class="container mx-auto p-8 flex-grow">
        
        <h1 class="text-3xl md:text-4xl font-extrabold mb-4 text-white text-center">Pr√©diction et Mod√©lisation</h1>
        <p class="text-gray-600 mb-8 text-center"></p>

        <!-- Section Corr√©lation -->
        <div class="main-card p-6 md:p-10 text-center mb-8">
            <div class="mb-8">
                <button id="getCorrelationBtn" class="btn-gradient flex items-center justify-center mx-auto">
                    <span id="correlation-text">Analyser les corr√©lations</span>
                    <span id="correlation-spinner" class="loading-spinner ml-2 hidden"></span>
                </button>
            </div>
        </div>

        <div id="correlation-section" class="main-card text-center mb-8 hidden">
            <div class="p-6 md:p-10 text-center">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Matrice de Corr√©lation</h2>
            </div>
            
            <div id="correlation-plot" class="plot-container"></div>
            
            <!-- BOUTON ET ZONE D'EXPLICATION CORR√âLATIONS -->
            <div class="mt-6 mb-4">
                <button id="toggleCorrelationDetailsBtn" class="btn-gradient hidden mx-auto items-center justify-center">
                    <span class="mr-2">üîç</span> Analyser les liens (PM10, Temp, CO2, COV)
                </button>
            </div>

            <div id="top-correlations" class="px-6 pb-8 hidden transition-all duration-500">
                <!-- Rempli par JS avec les tableaux d'explication -->
            </div>

            <div class="p-6 md:p-10 text-center border-t border-gray-100">
                <button id="downloadCorrelationBtn" class="btn-gradient mt-4">T√©l√©charger la matrice</button>
            </div>
        </div>

        <!-- Section Formulaire de Pr√©diction -->
        <div class="main-card p-6 md:p-10 text-center mb-8">
            <form id="prediction-form" class="space-y-4 pt-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Configuration du Mod√®le</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left">
                    <!-- Variable Cible -->
                    <div>
                        <label for="targetCol" class="block text-gray-700 font-bold mb-2">Variable Cible</label>
                        <select id="targetCol" name="targetCol" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:ring-2 focus:ring-blue-500"></select>
                    </div>

                    <!-- Choix du Mod√®le -->
                    <div>
                        <label for="modelSelect" class="block text-gray-700 font-bold mb-2">Mod√®les</label>
                        <select id="modelSelect" name="modelSelect" class="w-full p-2 border border-gray-300 rounded-md text-gray-900 focus:ring-2 focus:ring-blue-500">
                            <option value="all">Comparaison (Tous)</option>
                            <option value="lr" selected>R√©gression Lin√©aire</option>
                            <option value="rf">Random Forest</option>
                            <option value="gb">Gradient Boosting</option>
                        </select>
                    </div>

                    <!-- Variables Explicatives -->
                    <div>
                        <label for="explanatoryCols" class="block text-gray-700 font-bold mb-2">Variables Explicatives</label>
                        <select id="explanatoryCols" name="explanatoryCols" multiple class="w-full p-2 border border-gray-300 rounded-md h-32 text-gray-900 focus:ring-2 focus:ring-blue-500"></select>
                        <p class="text-xs text-gray-500 mt-1">Maintenez Ctrl (ou Cmd) pour s√©lectionner plusieurs variables.</p>
                    </div>
                </div>

                <button type="submit" id="train-btn" class="btn-gradient w-full md:w-auto flex items-center justify-center mx-auto mt-6">
                    <span id="train-text">Entra√Æner et Pr√©dire</span>
                    <span id="train-spinner" class="loading-spinner ml-2 hidden"></span>
                </button>
            </form>
            <div id="message-container" class="mt-4 text-center text-lg"></div>
        </div>

        <!-- Section R√©sultats -->
        <div id="results-section" class="main-card p-6 md:p-10 text-center hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">R√©sultats de la Pr√©diction</h2>
            
            <!-- M√©triques de performance -->
            <div id="prediction-metrics" class="bg-gray-100 p-6 rounded-2xl mb-8 text-left text-gray-800 grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Rempli dynamiquement par JS -->
            </div>
            
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Graphique Pr√©visionnel</h3>
            <div id="prediction-plot" class="plot-container"></div> 
            
            <div id="table-container-wrapper">
                 <button id="toggleTableBtn" class="btn-gradient mt-4 mb-4">Voir le Tableau des Pr√©dictions</button>
                 <div id="predictionTableContainer" class="data-table mt-4 hidden">
                    <!-- Table remplie dynamiquement par JS -->
                 </div>
            </div>

            <div id="redirect-btn-container" class="mt-6 flex flex-wrap gap-4 justify-center hidden">
                <!-- BOUTON : AIDE AU CHOIX DU MOD√àLE (MODIFI√â) -->
                <button id="validateModelBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center border-2 border-white/20">
                    <span class="mr-2 text-xl">üìä</span> 
                    <span>Interpr√©ter & Choisir le Mod√®le</span>
                </button>
                
                <button id="downloadPredictionBtn" class="btn-gradient">T√©l√©charger le graphique</button>
                <button onclick="window.location.href='/comparaison'" class="btn-gradient">Aller √† la page de comparaison</button>
            </div>
        </div>

    </main>

    <!-- MODALE DE GUIDE D'INTERPR√âTATION -->
    <div id="validation-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 backdrop-blur-sm"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-100 transition-transform duration-300">
            
            <!-- Header -->
            <div class="modal-content py-5 text-left px-6">
                <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                    <p class="text-2xl font-extrabold text-gray-800 flex items-center">
                        <span class="text-blue-500 mr-2">üéì</span> Guide de Performance
                    </p>
                    <div class="modal-close cursor-pointer z-50 hover:bg-gray-100 p-2 rounded-full transition" id="closeModalCross">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Body : Explication P√©dagogique -->
                <div class="my-5 space-y-6">
                    
                    <!-- 1. Comprendre le Score R¬≤ -->
                    <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100">
                        <h3 class="font-bold text-indigo-900 mb-2 text-lg">1. Le Score R¬≤ (La Fiabilit√©)</h3>
                        <p class="text-sm text-gray-600 mb-3">Ce score indique √† quel point le mod√®le "colle" √† la r√©alit√© (max = 1).</p>
                        
                        <ul class="space-y-2">
                            <li class="flex items-center">
                                <span class="perf-badge perf-good">R¬≤ > 0.80</span> 
                                <span class="text-sm text-gray-700 font-medium">Excellent. Pr√©dictions tr√®s fiables.</span>
                            </li>
                            <li class="flex items-center">
                                <span class="perf-badge perf-avg">0.60 - 0.80</span> 
                                <span class="text-sm text-gray-700">Correct. Tendances respect√©es.</span>
                            </li>
                            <li class="flex items-center">
                                <span class="perf-badge perf-bad">R¬≤ < 0.60</span> 
                                <span class="text-sm text-gray-700">Faible. √Ä ne pas choisir.</span>
                            </li>
                        </ul>
                    </div>

                    <!-- 2. Comprendre les Erreurs (MSE / MAE) -->
                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2 text-lg">2. La Marge d'Erreur (MSE)</h3>
                        <p class="text-sm text-gray-600">
                            C'est l'√©cart moyen entre la pr√©diction et la r√©alit√©. 
                            <br><span class="font-bold text-blue-600">Objectif :</span> Avoir le chiffre le plus bas possible (proche de 0).
                        </p>
                    </div>

                    <!-- 3. Conseil de choix -->
                    <div class="p-4 border-2 border-dashed border-blue-200 rounded-xl bg-blue-50/50">
                        <p class="text-sm text-blue-800 flex items-start">
                            <span class="text-xl mr-2">üí°</span>
                            <span><strong>Conseil :</strong> Regardez les r√©sultats ci-dessus. Le meilleur mod√®le est celui qui combine le <span class="font-bold text-green-600">R¬≤ le plus haut</span> (proche de 1) et le <span class="font-bold text-green-600">MSE le plus bas</span>.</span>
                        </p>
                    </div>

                    <!-- 4. Lien externe -->
                    <div class="mt-6 pt-4 border-t border-gray-100">
                        <p class="text-gray-600 text-sm mb-3 font-medium">Une fois le mod√®le choisi, validez la tendance globale :</p>
                        <a href="https://www.meteoart.com/europe/france" target="_blank" class="flex items-center justify-center w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-xl transition shadow-md transform hover:-translate-y-0.5">
                            <span class="mr-2">üåç</span> V√©rifier sur MeteoArt (France)
                        </a>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-end pt-2">
                    <button id="closeModalBtn" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-transparent text-gray-400 p-4 mt-8 text-center">
        <div class="container mx-auto">
            <div class="flex justify-center items-center space-x-6 text-2xl mb-4">
                <a href="/" class="transform hover:scale-110 transition duration-300">‚ú® Accueil</a>
                <a href="/upload-data" class="transform hover:scale-110 transition duration-300">üìÅ Chargement</a>
                <a href="/data-preparation" class="transform hover:scale-110 transition duration-300">üßº Nettoyage</a>
                <a href="/visualizations" class="transform hover:scale-110 transition duration-300">üìà Visualisation</a>
                <a href="/prediction-modeling" class="transform hover:scale-110 transition duration-300">üîÆ Pr√©diction</a>
                <a href="/comparaison" class="transform hover:scale-110 transition duration-300">üåê Comparaison</a>
            </div>
        </div>
    </footer>

    <script>
        // √âl√©ments DOM
        const getCorrelationBtn = document.getElementById('getCorrelationBtn');
        const correlationSection = document.getElementById('correlation-section');
        const correlationPlot = document.getElementById('correlation-plot');
        const downloadCorrelationBtn = document.getElementById('downloadCorrelationBtn');
        const topCorrelationDiv = document.getElementById('top-correlations'); 
        const toggleCorrelationDetailsBtn = document.getElementById('toggleCorrelationDetailsBtn');
        
        const targetColSelect = document.getElementById('targetCol');
        const explanatoryColsSelect = document.getElementById('explanatoryCols');
        const modelSelect = document.getElementById('modelSelect');
        
        const predictionForm = document.getElementById('prediction-form');
        const predictionMetricsDiv = document.getElementById('prediction-metrics');
        const predictionPlotDiv = document.getElementById('prediction-plot');
        const resultsSection = document.getElementById('results-section');
    
        const predictionTableContainer = document.getElementById('predictionTableContainer');
        
        const messageContainer = document.getElementById('message-container');
        const trainBtn = document.getElementById('train-btn');
        const trainText = document.getElementById('train-text');
        const trainSpinner = document.getElementById('train-spinner');
        const redirectBtnContainer = document.getElementById('redirect-btn-container');
        const downloadPredictionBtn = document.getElementById('downloadPredictionBtn');
        const correlationText = document.getElementById('correlation-text');
        const correlationSpinner = document.getElementById('correlation-spinner');
        const toggleTableBtn = document.getElementById('toggleTableBtn');

        // NOUVEAUX √âL√âMENTS POUR LA MODALE
        const validateModelBtn = document.getElementById('validateModelBtn');
        const validationModal = document.getElementById('validation-modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalCross = document.getElementById('closeModalCross');
        const modalOverlay = document.querySelector('.modal-overlay');

        let allColumns = [];
        // Mise √† jour des mots cl√©s
        const targetKeywords = ['temp√©rature', 'humidit√©','pm10', 'cov', 'co2', 'lumi√®re'];
        const meteoKeywords = ['temp√©rature', 'humidit√©', 'lumi√®re','pression','co2'];
        const pollutantKeywords = ['pm10', 'cov','iqa', 'co2'];
        // AJOUT DES EXCLUSIONS STRICTES POUR DIFF ET ROSEE
        const permanentExclusionsKeywords = [
             'la diff', 'le mois', 'la ville', 'rosee', 'diff',
            'temps', 'date','nox' ,'le point rose',  'heure','point_de_rosee', 'diff_temp_rosee', 'diff_point_rosee','pm1','pm2_5','iqa'
        ];

        // --- GESTION DE LA MODALE ---
        const toggleModal = () => {
            validationModal.classList.toggle('hidden');
            document.body.classList.toggle('modal-active');
        }

        validateModelBtn.addEventListener('click', toggleModal);
        closeModalBtn.addEventListener('click', toggleModal);
        closeModalCross.addEventListener('click', toggleModal);
        modalOverlay.addEventListener('click', toggleModal);

        // --- GESTION DU TOGGLE EXPLICATION CORR√âLATION ---
        toggleCorrelationDetailsBtn.addEventListener('click', () => {
            if (topCorrelationDiv.classList.contains('hidden')) {
                topCorrelationDiv.classList.remove('hidden');
                toggleCorrelationDetailsBtn.innerHTML = '<span class="mr-2">üîº</span> Masquer les d√©tails';
            } else {
                topCorrelationDiv.classList.add('hidden');
                toggleCorrelationDetailsBtn.innerHTML = '<span class="mr-2">üîç</span> Analyser les liens (PM10, Temp, CO2, COV)';
            }
        });

        // --- Fonction d'agr√©gation horaire ---
        const aggregateToHourlyMean = (predictions) => {
            if (!predictions || predictions.length === 0) return [];
            
            const hourlyGroups = {};

            predictions.forEach((p) => {
                const date = new Date(p.time.replace(' ', 'T'));
                const hourKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}-${date.getHours()}`;

                if (!hourlyGroups[hourKey]) {
                    hourlyGroups[hourKey] = {
                        sum: 0,
                        count: 0,
                        firstTime: p.time, 
                        firstDateObj: date
                    };
                }
                
                if (date < hourlyGroups[hourKey].firstDateObj) {
                     hourlyGroups[hourKey].firstDateObj = date;
                     hourlyGroups[hourKey].firstTime = p.time;
                }

                hourlyGroups[hourKey].sum += p.value;
                hourlyGroups[hourKey].count += 1;
            });

            const aggregatedList = Object.values(hourlyGroups).map(group => {
                const date = new Date(group.firstTime.replace(' ', 'T'));
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const timePart = date.toTimeString().substring(0, 5); 
                
                const displayDateTime = `${day}/${month} ${timePart}`;
                
                return {
                    time: displayDateTime, 
                    value: group.sum / group.count 
                };
            });

            aggregatedList.sort((a, b) => 0);
            return aggregatedList;
        };

        const displayMessage = (msg, type) => {
            if (type === 'success' || type === 'info') {
                messageContainer.textContent = '';
            } else {
                messageContainer.textContent = msg;
                messageContainer.style.color = (type === 'error') ? '#ff4d4d' : 'black';
            }
        };

        // --- Chargement des Colonnes ---
        const fetchAndPopulateColumns = async () => {
            try {
                const response = await fetch('/get_data_columns');
                const result = await response.json();
                if (response.ok) {
                    allColumns = result.columns;
                    
                    const filteredTargets = allColumns.filter(col => 
                        targetKeywords.some(keyword => col.toLowerCase().includes(keyword))
                    );

                    populateSelect(targetColSelect, filteredTargets);

                    const defaultTarget = filteredTargets.find(col => col.toLowerCase().includes('temp√©rature'));
                    if (defaultTarget) {
                        targetColSelect.value = defaultTarget;
                    } else if (filteredTargets.length > 0) {
                        targetColSelect.value = filteredTargets[0];
                    }

                    updateExplanatoryVariables();
                } else {
                    displayMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur colonnes:', error);
                displayMessage('Erreur chargement colonnes.', 'error');
            }
        };

        const populateSelect = (selectElement, options) => {
            selectElement.innerHTML = '';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        };

        const updateExplanatoryVariables = () => {
            const targetCol = targetColSelect.value;
            const lowerTargetCol = targetCol.toLowerCase();
            let isMeteoTarget = meteoKeywords.some(keyword => lowerTargetCol.includes(keyword));
            let isPollutantTarget = pollutantKeywords.some(keyword => lowerTargetCol.includes(keyword));

            const explanatoryColumns = allColumns.filter(col => {
                const lowerCol = col.toLowerCase();
                if (col === targetCol) return false;
                
                const isPermanentlyExcluded = permanentExclusionsKeywords.some(keyword => lowerCol.includes(keyword));
                if (isPermanentlyExcluded) return false;
                
                if (isMeteoTarget) {
                    return meteoKeywords.some(keyword => lowerCol.includes(keyword));
                } else if (isPollutantTarget) {
                    return true;
                }
                return true;
            });
            
            populateSelect(explanatoryColsSelect, explanatoryColumns);
            Array.from(explanatoryColsSelect.options).forEach(option => {
                option.selected = true;
            });
        };

        // --- Corr√©lation & Analyse Top 3 ---
        const fetchCorrelationMatrix = async () => {
            correlationText.classList.add('hidden');
            correlationSpinner.classList.remove('hidden');
            getCorrelationBtn.disabled = true;
            displayMessage('', 'info');
            
            correlationPlot.innerHTML = '';
            topCorrelationDiv.innerHTML = ''; // Reset
            topCorrelationDiv.classList.add('hidden');
            toggleCorrelationDetailsBtn.classList.add('hidden'); // Reset bouton toggle
            correlationSection.classList.remove('hidden'); 

            try {
                const response = await fetch('/get_correlation_matrix');
                const result = await response.json();
                if (response.ok) {
                    const plotData = JSON.parse(result.plot_json);
                    const layout = {
                        ...plotData.layout,
                        autosize: true,
                        width: null,    
                        height: null,   
                        margin: { l: 2, r: 2, t: 3, b: 2 },
                    };
                    Plotly.newPlot('correlation-plot', plotData.data, layout, { responsive: true });
                    displayMessage('', 'success');

                    // --- CALCUL ET AFFICHAGE DES MEILLEURES CORRELATIONS ---
                    try {
                        const matrix = plotData.data[0].z;
                        const labels = plotData.data[0].x;
                        
                        let topCorrHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 text-left">';

                        // Fonction pour g√©n√©rer le bloc HTML pour une cat√©gorie
                        const generateTopBlock = (keywords, title, colorClass) => {
                            const targetIndices = labels.map((l, i) => {
                                const lowerL = l.toLowerCase();
                                // V√©rifier si le label contient un mot-cl√© ET n'est pas exclu
                                const isMatch = keywords.some(k => lowerL.includes(k));
                                const isExcluded = permanentExclusionsKeywords.some(ex => lowerL.includes(ex));
                                return (isMatch && !isExcluded) ? i : -1;
                            }).filter(i => i !== -1);

                            if (targetIndices.length === 0) return '';

                            let html = `<div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                            <h4 class="font-bold text-${colorClass}-700 mb-3 text-lg border-b border-gray-100 pb-2 flex items-center">
                                                ${title}
                                            </h4>
                                            <div class="space-y-4">`;

                            targetIndices.forEach(idx => {
                                const varName = labels[idx];
                                const correlations = matrix[idx].map((val, i) => ({ name: labels[i], val: val }));
                                
                                const top3 = correlations
                                    .filter(c => c.name !== varName)
                                    // FILTRER EGALEMENT LES VARIABLES EXCLUES DE LA LISTE DES CORR√âLATIONS
                                    .filter(c => !permanentExclusionsKeywords.some(ex => c.name.toLowerCase().includes(ex)))
                                    .sort((a, b) => Math.abs(b.val) - Math.abs(a.val))
                                    .slice(0, 3);

                                html += `<div>
                                            <p class="text-sm font-semibold text-gray-800 mb-1">Corr√©lations avec <span class="text-${colorClass}-600">${varName}</span> :</p>
                                            <ul class="text-xs space-y-1 pl-2 border-l-2 border-${colorClass}-200">
                                                ${top3.map(c => `
                                                    <li class="flex justify-between items-center p-1 hover:bg-gray-50 rounded">
                                                        <span class="text-gray-600 truncate mr-2" title="${c.name}">${c.name}</span>
                                                        <span class="font-mono font-bold ${c.val > 0.5 ? 'text-green-600' : (c.val < -0.5 ? 'text-red-500' : 'text-gray-400')}">
                                                            ${c.val > 0 ? '+' : ''}${c.val.toFixed(2)}
                                                        </span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                         </div>`;
                            });
                            html += `</div></div>`;
                            return html;
                        };

                        // G√âN√âRATION DES BLOCS POUR LES VARIABLES DEMAND√âES (PM10 seulement)
                        // J'ai remis ['pm'] ici pour √™tre s√ªr de capter les colonnes nomm√©es "PM" ou "Particules"
                        // Les exclusions de PM1 et PM2.5 se font via permanentExclusionsKeywords
                        topCorrHtml += generateTopBlock(['pm'], ' Particules Fines', 'gray');
                        topCorrHtml += generateTopBlock(['temp', 't¬∞'], ' Temp√©rature', 'red');
                        topCorrHtml += generateTopBlock(['co2'], ' CO2 ', 'blue');
                        topCorrHtml += generateTopBlock(['cov', 'voc'], 'COV', 'purple');
                        
                        topCorrHtml += '</div>';
                        
                        // Ajout de la ligne d'interpr√©tation demand√©e
                        topCorrHtml += `
                            <div class="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-900 flex items-start">
                                <span class="text-xl mr-2">üí°</span>
                                <p><strong>Interpr√©tation :</strong> Une valeur proche de <span class="font-bold text-green-600">+1</span> signifie que les variables augmentent ensemble. Une valeur proche de <span class="font-bold text-red-500">-1</span> signifie qu'elles varient en sens inverse.</p>
                            </div>
                        `;

                        if (topCorrHtml.includes('bg-white')) { // V√©rifie qu'au moins un bloc a √©t√© cr√©√©
                            topCorrelationDiv.innerHTML = topCorrHtml;
                            toggleCorrelationDetailsBtn.classList.remove('hidden');
                            toggleCorrelationDetailsBtn.classList.add('flex');
                        }

                    } catch (e) {
                        console.error("Erreur lors du calcul des top corr√©lations JS", e);
                    }
                    // -------------------------------------------------------

                } else {
                    displayMessage(result.error, 'error');
                    correlationSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur corr√©lation:', error);
                displayMessage('Erreur inattendue.', 'error');
                correlationSection.classList.add('hidden');
            } finally {
                correlationText.classList.remove('hidden');
                correlationSpinner.classList.add('hidden');
                getCorrelationBtn.disabled = false;
            }
        };

        // --- Entra√Ænement et Pr√©diction ---
        const trainAndPredict = async () => {
            const targetCol = targetColSelect.value;
            const selectedModelType = modelSelect.value; 
            
            const featureCols = Array.from(explanatoryColsSelect.options)
                                         .filter(option => option.selected)
                                         .map(option => option.value);

            if (!targetCol || featureCols.length === 0) {
                displayMessage('S√©lectionnez au moins une variable cible et une explicative.', 'error');
                return;
            }

            trainBtn.disabled = true;
            trainText.classList.add('hidden');
            trainSpinner.classList.remove('hidden');
            displayMessage('', 'info');
            resultsSection.classList.add('hidden');

            try {
                const response = await fetch('/train_predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetCol: targetCol, featureCols: featureCols }), 
                });
                const result = await response.json();

                if (response.ok) {
                    const preds_lr = aggregateToHourlyMean(result.predictions_lr || []);
                    const preds_rf = aggregateToHourlyMean(result.predictions_rf || []);
                    const preds_gb = aggregateToHourlyMean(result.predictions_gb || []);

                    let plotTraces = [];
                    let tableHeaders = `<th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Date/Heure</th>`;
                    let metricsHtml = '';

                    const addMetric = (title, data) => {
                        if(!data) return;
                        metricsHtml += `
                            <div class="bg-white p-4 rounded shadow">
                                <h4 class="font-bold text-blue-600 mb-2">${title}</h4>
                                <p class="text-sm"><strong>R¬≤:</strong> ${(data.r2 !== undefined ? data.r2.toFixed(4) : 'N/A')}</p>
                                <p class="text-sm"><strong>MSE:</strong> ${(data.mse !== undefined ? data.mse.toFixed(4) : 'N/A')}</p>
                                <p class="text-sm"><strong>MAE:</strong> ${(data.mae !== undefined ? data.mae.toFixed(4) : 'N/A')}</p>
                            </div>`;
                    };

                    const addTrace = (name, color, data) => {
                        plotTraces.push({
                            x: data.map(p => p.time),
                            y: data.map(p => p.value),
                            mode: 'lines+markers',
                            name: name,
                            line: { color: color, width: 2 }
                        });
                    };

                    const showLR = (selectedModelType === 'all' || selectedModelType === 'lr');
                    const showRF = (selectedModelType === 'all' || selectedModelType === 'rf');
                    const showGB = (selectedModelType === 'all' || selectedModelType === 'gb');

                    if (showLR) {
                        addMetric("R√©gression Lin√©aire", result.results['Linear Regression']);
                        addTrace("R√©gression Lin√©aire", 'rgb(46, 204, 113)', preds_lr); 
                        tableHeaders += `<th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Lin√©aire (Moy.)</th>`;
                    }
                    if (showRF) {
                        addMetric("Random Forest", result.results['Random Forest']);
                        addTrace("Random Forest", 'rgb(75, 82, 255)', preds_rf); 
                        tableHeaders += `<th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Rand. Forest (Moy.)</th>`;
                    }
                    if (showGB) {
                        addMetric("Gradient Boosting", result.results['Gradient Boosting']);
                        addTrace("Gradient Boosting", 'rgb(255, 105, 180)', preds_gb); 
                        tableHeaders += `<th class="px-4 py-2 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Grad. Boosting (Moy.)</th>`;
                    }

                    predictionMetricsDiv.innerHTML = metricsHtml;

                    const timeRef = (preds_gb.length > 0 ? preds_gb : (preds_rf.length > 0 ? preds_rf : preds_lr));
                    
                    let tableBodyRows = timeRef.map((refItem, index) => {
                        let rowHtml = `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${refItem.time}</td>`;
                        
                        if (showLR) {
                            const val = preds_lr[index] ? preds_lr[index].value : 'N/A';
                            rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${typeof val === 'number' ? val.toFixed(2) : val}</td>`;
                        }
                        if (showRF) {
                            const val = preds_rf[index] ? preds_rf[index].value : 'N/A';
                            rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${typeof val === 'number' ? val.toFixed(2) : val}</td>`;
                        }
                        if (showGB) {
                            const val = preds_gb[index] ? preds_gb[index].value : 'N/A';
                            rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${typeof val === 'number' ? val.toFixed(2) : val}</td>`;
                        }
                        return `<tr class="hover:bg-gray-50">${rowHtml}</tr>`;
                    }).join('');

                    const tableHtml = `
                        <h3 class="text-xl font-bold mb-3 text-gray-800">D√©tail des Pr√©dictions (Moyenne Horaire)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 bg-white rounded-xl shadow-lg">
                                <thead class="bg-gray-50"><tr>${tableHeaders}</tr></thead>
                                <tbody class="divide-y divide-gray-200">${tableBodyRows}</tbody>
                            </table>
                        </div>
                    `;
                    
                    predictionTableContainer.innerHTML = tableHtml;

                    const layout = {
                        title: `Pr√©dictions futures pour ${targetCol}`,
                        xaxis: { title: 'Temps', type: 'category' },
                        yaxis: { title: targetCol },
                        margin: { l: 60, r: 60, b: 60, t: 60 },
                        legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, xanchor: 'right', x: 1 }
                    };

                    Plotly.newPlot('prediction-plot', plotTraces, layout, { responsive: true });
                    
                    displayMessage('', 'success');
                    resultsSection.classList.remove('hidden');
                    redirectBtnContainer.classList.remove('hidden');
                    downloadPredictionBtn.classList.remove('hidden');

                } else {
                    displayMessage(result.error || 'Erreur lors de l\'entra√Ænement.', 'error');
                }
            } catch (error) {
                console.error('Erreur JS:', error);
                displayMessage('Erreur inattendue (Dataset trop petit ou connexion perdue).', 'error');
            } finally {
                trainBtn.disabled = false;
                trainText.classList.remove('hidden');
                trainSpinner.classList.add('hidden');
                setTimeout(() => {
                     if (document.getElementById('prediction-plot').data) Plotly.relayout('prediction-plot', {autosize: true});
                }, 100);
            }
        };

        toggleTableBtn.addEventListener('click', function() {
            if (predictionTableContainer.classList.contains('hidden')) {
                predictionTableContainer.classList.remove('hidden');
                this.textContent = 'Masquer le Tableau';
            } else {
                predictionTableContainer.classList.add('hidden');
                this.textContent = 'Afficher le Tableau';
            }
        });

        downloadCorrelationBtn.addEventListener('click', () => {
            Plotly.downloadImage('correlation-plot', { format: 'png', filename: 'matrice_correlation' });
        });

        downloadPredictionBtn.addEventListener('click', () => {
            Plotly.downloadImage('prediction-plot', { format: 'png', filename: 'prediction_graph' });
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndPopulateColumns();
            getCorrelationBtn.addEventListener('click', fetchCorrelationMatrix);
            predictionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                trainAndPredict();
            });
            targetColSelect.addEventListener('change', updateExplanatoryVariables);
        });
        
        window.addEventListener('resize', () => {
            const predPlot = document.getElementById('prediction-plot');
            if (predPlot && predPlot.data) Plotly.relayout('prediction-plot', {autosize: true});
            
            const corrPlot = document.getElementById('correlation-plot');
            if (corrPlot && corrPlot.data) Plotly.relayout('correlation-plot', {autosize: true});
        });
    </script>
</body>
</html>