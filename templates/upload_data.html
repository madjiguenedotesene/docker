<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acc√®s aux Donn√©es - Eurosmart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed top-0 left-0 w-full z-50 p-4 top-nav backdrop-blur-md shadow-md">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center">
                 <img src="static/images/logo.png" alt="Logo Eurosmart" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 flex-grow flex flex-col md:flex-row gap-6 pt-24">
        
        <aside id="sidebar-panel" class="hidden w-full md:w-1/3 lg:w-1/4 flex-col h-[80vh] transition-all duration-300">
            <div class="bg-black/30 backdrop-blur-md border border-white/20 rounded-[2rem] p-4 flex flex-col h-full shadow-xl text-white">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold">üìç Sites Eurosmart</h2>
                    <button id="close-sidebar-btn" class="hover:text-red-400 transition-colors text-xl">‚úï</button>
                </div>
                <div id="sidebar-list" class="flex-grow overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                    <div class="animate-pulse text-sm">Chargement de la liste...</div>
                </div>
            </div>
        </aside>

        <div id="main-content" class="w-full transition-all duration-300">
            <h1 class="text-3xl font-extrabold mb-6 text-white text-center md:text-left">Chargement des Donn√©es</h1>

            <div class="flex gap-4 mb-6 justify-center md:justify-start">
                <button onclick="switchTab('eurosmart')" id="btn-tab-eurosmart" class="btn-gradient px-8 py-2 rounded-full text-sm shadow-lg hover:scale-105 transition-all">
                    üåê Eurosmart API
                </button>
                <button onclick="switchTab('local')" id="btn-tab-local" class="nav-link px-8 py-2 border-white/30 text-white/70 hover:scale-105 transition-all">
                    üíª Fichier Local
                </button>
            </div>

            <div class="main-card p-6 md:p-10 relative bg-white rounded-[2rem]">
                
                <form id="upload-form" class="space-y-4 max-w-2xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Identifiant</label>
                            <input type="text" name="username" required placeholder="Login" class="w-full p-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mot de passe</label>
                            <input type="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                    </div>

                    <div class="text-left space-y-4">
                        <div class="flex justify-between items-end">
                            <div>
                                <label class="block text-gray-700 font-bold">Codes Exp√©rience</label>
                                <p class="text-[10px] text-gray-400 italic">S√©parez les codes par des virgules (ex: PARIS-01, EVRY-REEL)</p>
                            </div>
                            <button type="button" id="toggle-sidebar-btn" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200">üìç Voir la liste</button>
                        </div>
                        <div class="relative">
                            <input type="text" id="code-exp" name="code_exp" placeholder="S√©lectionnez ou saisissez vos codes..." class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-purple-500 outline-none text-gray-800 shadow-inner pr-12">
                            <button type="button" id="search-icon-btn" class="absolute inset-y-0 right-0 pr-4 text-xl">üîç</button>
                        </div>
                    </div>

                    <button type="submit" class="btn-gradient w-full py-4 text-lg shadow-xl flex items-center justify-center gap-3 mt-4">
                        <span>Lancer l'import group√©</span>
                        <div id="upload-spinner" class="hidden loading-spinner border-t-white"></div>
                    </button>
                </form>

                <form id="local-form" class="space-y-6 max-w-2xl mx-auto hidden">
                    <div class="p-10 border-4 border-dashed border-purple-100 rounded-[2rem] bg-purple-50/30 text-center group hover:border-purple-300 transition-colors">
                        <label for="file_local" class="cursor-pointer block">
                            <span class="text-5xl block mb-3 group-hover:scale-110 transition-transform">üìÇ</span>
                            <span class="text-purple-700 font-bold text-lg">Importer des fichiers (CSV/Excel)</span>
                            <input type="file" id="file_local" name="file_local" class="hidden" accept=".csv, .xlsx, .xls" multiple>
                            <p id="file-name-display" class="mt-3 text-sm text-gray-400 italic">Aucun fichier s√©lectionn√©</p>
                        </label>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-bold mb-2 ml-1 text-left">Nom de la ville / du site</label>
                        <input type="text" name="city_manual" placeholder="Ex: Salon, Bureau, Lille..." class="w-full p-4 border-2 border-gray-100 rounded-2xl outline-none focus:border-purple-500 shadow-inner">
                    </div>

                    <button type="submit" class="btn-gradient w-full py-4 text-lg shadow-xl flex items-center justify-center gap-3">
                        <span>Charger les fichiers locaux</span>
                        <div id="local-spinner" class="hidden loading-spinner border-t-white"></div>
                    </button>
                </form>

                <div id="message-container" class="mt-6 text-center font-medium"></div>
            </div>

            <div id="df-preview-card" class="main-card p-6 md:p-10 mt-8 hidden bg-white rounded-[2rem]">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div id="df-info" class="text-gray-700"></div>
                    <a href="/download_data" class="btn-gradient px-6 py-2 text-sm flex items-center gap-2">üì• T√©l√©charger CSV</a>
                </div>
                <div class="table-preview overflow-x-auto"><div id="df-preview"></div></div>
                <div id="redirect-btn-container" class="mt-8 flex justify-center hidden">
                    <a href="/visualizations" class="btn-gradient px-10 py-4 text-lg">Visualiser les donn√©es ‚Üí</a>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer-transparent text-gray-400 p-6 mt-8 text-center">
        <div class="container mx-auto flex flex-wrap justify-center gap-6">
            <a href="/" class="nav-link">‚ú® Accueil</a>
            <a href="/upload-data" class="nav-link">üìÅ Chargement</a>
            <a href="/prediction-modeling" class="nav-link">üîÆ Pr√©diction</a>
            <a href="/visualizations" class="nav-link">üìà Visualisation</a>
            <a href="/comparaison" class="nav-link">üåê Comparaison</a>
        </div>
    </footer>

    <script>
        const messageContainer = document.getElementById('message-container');
        const previewCard = document.getElementById('df-preview-card');
        const redirectContainer = document.getElementById('redirect-btn-container');
        const codeExpInput = document.getElementById('code-exp');

        // --- NAVIGATION ONGLET ---
        function switchTab(mode) {
            const euroForm = document.getElementById('upload-form');
            const localForm = document.getElementById('local-form');
            const btnEuro = document.getElementById('btn-tab-eurosmart');
            const btnLocal = document.getElementById('btn-tab-local');
            const sidebar = document.getElementById('sidebar-panel');

            if (mode === 'eurosmart') {
                euroForm.classList.remove('hidden');
                localForm.classList.add('hidden');
                btnEuro.className = "btn-gradient px-8 py-2 rounded-full text-sm shadow-lg hover:scale-105 transition-all";
                btnLocal.className = "nav-link px-8 py-2 border-white/30 text-white/70 hover:scale-105 transition-all";
            } else {
                euroForm.classList.add('hidden');
                localForm.classList.remove('hidden');
                sidebar.classList.add('hidden');
                btnLocal.className = "btn-gradient px-8 py-2 rounded-full text-sm shadow-lg hover:scale-105 transition-all";
                btnEuro.className = "nav-link px-8 py-2 border-white/30 text-white/70 hover:scale-105 transition-all";
            }
        }

        // --- SIDEBAR ---
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const sidebarPanel = document.getElementById('sidebar-panel');
        const mainContent = document.getElementById('main-content');
        
        toggleSidebarBtn.addEventListener('click', () => {
            sidebarPanel.classList.remove('hidden');
            sidebarPanel.classList.add('flex');
            mainContent.classList.add('md:w-2/3', 'lg:w-3/4');
            toggleSidebarBtn.classList.add('hidden');
        });

        document.getElementById('close-sidebar-btn').addEventListener('click', () => {
            sidebarPanel.classList.add('hidden');
            mainContent.classList.remove('md:w-2/3', 'lg:w-3/4');
            toggleSidebarBtn.classList.remove('hidden');
        });

        // --- GESTION FICHIERS LOCAUX ---
        document.getElementById('file_local').addEventListener('change', (e) => {
            const files = e.target.files;
            const display = document.getElementById('file-name-display');
            display.textContent = files.length > 0 ? `${files.length} fichier(s) s√©lectionn√©(s)` : "Aucun fichier s√©lectionn√©";
        });

        // --- LOGIQUE ENVOI ---
        const displayMessage = (msg, type) => {
            messageContainer.textContent = msg;
            messageContainer.className = `mt-6 p-4 rounded-xl text-center font-medium ${type === 'error' ? 'bg-red-500/10 text-red-400 border border-red-500/20' : 'bg-blue-500/10 text-blue-300 border border-blue-500/20'}`;
        };

        const handleSuccess = (result) => {
            document.getElementById('df-preview').innerHTML = result.preview;
            document.getElementById('df-info').innerHTML = `<p class="text-green-600 font-bold">‚úì Chargement r√©ussi</p><p class="text-xs text-gray-500">${result.data_info.rows} lignes fusionn√©es.</p>`;
            previewCard.classList.remove('hidden');
            redirectContainer.classList.remove('hidden');
            displayMessage('Donn√©es fusionn√©es avec succ√®s.', 'success');
            previewCard.scrollIntoView({ behavior: 'smooth' });
        };

        // Formulaire API
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const spinner = document.getElementById('upload-spinner');
            spinner.classList.remove('hidden');
            displayMessage('Requ√™te multi-sites en cours...', 'info');
            try {
                const response = await fetch('/upload', { method: 'POST', body: new FormData(e.target) });
                const result = await response.json();
                response.ok ? handleSuccess(result) : displayMessage(result.error, 'error');
            } catch (err) { displayMessage('Erreur r√©seau.', 'error'); }
            finally { spinner.classList.add('hidden'); }
        });

        // Formulaire Local
        document.getElementById('local-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const spinner = document.getElementById('local-spinner');
            spinner.classList.remove('hidden');
            try {
                const response = await fetch('/upload', { method: 'POST', body: new FormData(e.target) });
                const result = await response.json();
                response.ok ? handleSuccess(result) : displayMessage(result.error, 'error');
            } catch (err) { displayMessage('Erreur chargement.', 'error'); }
            finally { spinner.classList.add('hidden'); }
        });

        // --- CHARGEMENT SIDEBAR AVEC AJOUT MULTIPLE ---
        document.addEventListener('DOMContentLoaded', async () => {
            const list = document.getElementById('sidebar-list');
            const formatDate = (dateStr) => {
                if (!dateStr) return '...';
                return dateStr.split(' ')[0].split('-').reverse().join('/');
            };

            try {
                const res = await fetch('/api/experiments?t=' + Date.now());
                if (res.ok) {
                    const data = await res.json();
                    list.innerHTML = '';
                    data.forEach(exp => {
                        const item = document.createElement('div');
                        item.className = "p-3 rounded-xl bg-white/5 hover:bg-white/20 transition-all border border-white/10 cursor-pointer mb-3 group shadow-sm";
                        item.innerHTML = `
                            <div class="flex justify-between items-start mb-1">
                                <strong class="text-white text-sm">${exp.City || "Inconnu"}</strong>
                                <span class="text-[9px] text-blue-300 font-mono bg-blue-900/40 border border-blue-500/30 px-1.5 py-0.5 rounded-md">${exp.CodeExp}</span>
                            </div>
                            <div class="text-[10px] text-gray-400">
                                Du <strong>${formatDate(exp.StartDate)}</strong> au <strong>${formatDate(exp.LastUpdate)}</strong>
                            </div>
                        `;
                        
                        // Action au clic : Ajoute √† la liste existante au lieu de remplacer
                        item.onclick = () => { 
                            let currentVal = codeExpInput.value.trim();
                            if (currentVal === "") {
                                codeExpInput.value = exp.CodeExp;
                            } else if (!currentVal.includes(exp.CodeExp)) {
                                codeExpInput.value = currentVal + ", " + exp.CodeExp;
                            }
                        };
                        list.appendChild(item);
                    });
                }
            } catch (e) { list.innerHTML = '<p class="text-red-400 text-xs">Erreur de chargement liste</p>'; }
        });
    </script>
</body>
</html>