<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charger Donn√©es</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* Style personnalis√© pour la barre de d√©filement de la liste */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-900">

    <nav class="fixed top-0 left-0 w-full z-10 p-4 top-nav">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center z-10">
                 <img src="static/images/logo.png" alt="Logo Eurosmart Analytics" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end z-10">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>

    <!-- MAIN CONTAINER -->
    <main class="container mx-auto p-4 md:p-8 flex-grow flex flex-col md:flex-row gap-6 pt-24">
        
        <!-- 1. SIDEBAR : LISTE INTELLIGENTE (Masqu√©e par d√©faut) -->
        <aside id="sidebar-panel" class="hidden w-full md:w-1/3 lg:w-1/4 flex-col h-[80vh] transition-all duration-300">
            <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 flex flex-col h-full shadow-xl">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-white mb-1">üìç Sites Disponibles</h2>
                        <p class="text-[10px] text-gray-300">Ctrl + Clic pour s√©lectionner plusieurs</p>
                    </div>
                    <!-- Bouton pour fermer la liste sur mobile ou desktop -->
                    <button id="close-sidebar-btn" class="text-white hover:text-red-400 focus:outline-none">
                        ‚úï
                    </button>
                </div>
                <div class="mt-2 text-xs text-gray-200 mb-2" id="geo-status"></div>
                
                <!-- Zone de liste d√©filante -->
                <div id="sidebar-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-3 pr-2">
                    <div class="animate-pulse flex space-x-4">
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-white/20 rounded w-3/4"></div>
                            <div class="h-4 bg-white/20 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 2. MAIN CONTENT : FORMULAIRE -->
        <div id="main-content" class="w-full transition-all duration-300">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-6 text-white text-center md:text-left">Acc√©der aux Exp√©riences</h1>

            <div class="main-card p-6 md:p-10 text-center relative">
                
                <form id="upload-form" class="space-y-6 max-w-2xl mx-auto">
                    
                    <div class="text-left">
                        <div class="flex justify-between items-end mb-2">
                            <label for="code-exp" class="block text-gray-700 font-bold text-lg">
                                Codes Exp√©rience
                            </label>
                            
                            <!-- NOUVEAU BOUTON TOGGLE -->
                            <button type="button" id="toggle-sidebar-btn" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 transition-colors flex items-center gap-1">
                                <span>üìç Voir la liste des sites</span>
                            </button>
                        </div>
                        
                        <div class="relative">
                            <input type="text" 
                                   id="code-exp" 
                                   name="code_exp" 
                                   placeholder="Tapez un code ou s√©lectionnez dans la liste..." 
                                   class="w-full p-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-800 text-lg shadow-sm transition-all pr-12"
                                   autocomplete="off">
                            
                            <button type="button" 
                                    id="search-icon-btn"
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer hover:scale-110 transition-transform focus:outline-none"
                                    title="Lancer la recherche">
                                <span class="text-gray-400 text-xl hover:text-blue-600">üîç</span>
                            </button>
                        </div>

                        <p class="text-sm text-gray-500 mt-2">Vous pouvez saisir plusieurs codes s√©par√©s par des virgules.</p>

                        <div class="mt-4">
                            <button type="button" id="toggle-city-btn" class="text-blue-600 text-sm hover:underline focus:outline-none flex items-center">
                                <span>üìç La ville n'est pas d√©tect√©e ? Cliquez ici pour la saisir manuellement.</span>
                            </button>
                        </div>

                        <div id="city-input-container" class="hidden mt-3 transition-all duration-300 bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <label for="city-exp" class="block text-sm text-blue-800 font-semibold mb-1">
                                Ville par d√©faut (Optionnel)
                            </label>
                            <input type="text" 
                                   id="city-exp" 
                                   name="city_exp" 
                                   placeholder="Ex: Evry" 
                                   class="w-full p-2 border border-blue-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                            <p class="text-xs text-blue-600 mt-1">Cette ville sera utilis√©e si le syst√®me n'arrive pas √† la deviner via le code ou le GPS.</p>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button type="submit" id="upload-btn" class="btn-gradient w-full py-3 text-lg font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center">
                            <span id="upload-text">Charger les Donn√©es</span>
                            <div id="upload-spinner" class="hidden w-5 h-5 border-2 border-white border-opacity-50 rounded-full animate-spin ml-2"></div>
                        </button>
                    </div>
                </form>

                <div id="message-container" class="mt-6 text-center text-lg font-medium"></div>

            </div>

            <div id="df-preview-card" class="main-card p-6 md:p-10 text-center mt-8 hidden">
                <div id="df-info" class="text-left text-gray-700 mb-4 font-semibold"></div>
                <div class="table-preview">
                    <div id="df-preview" class="text-sm"></div>
                </div>
                <div id="redirect-btn-container" class="mt-6 flex flex-wrap gap-4 justify-center hidden">
                    <a href="/data-preparation" class="btn-gradient w-full md:w-auto">Aller √† la page de Nettoyage ‚Üí</a>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer-transparent text-gray-400 p-4 mt-8 text-center">
        <div class="container mx-auto">
            <div class="flex justify-center items-center space-x-6 text-2xl mb-4">
                <a href="/" class="transform hover:scale-110 transition duration-300">‚ú® Accueil</a>
                <a href="/upload-data" class="transform hover:scale-110 transition duration-300">üìÅ Chargement</a>
                <a href="/data-preparation" class="transform hover:scale-110 transition duration-300">üßº Nettoyage</a>
                <a href="/visualizations" class="transform hover:scale-110 transition duration-300">üìà Visualisation</a>
                <a href="/prediction-modeling" class="transform hover:scale-110 transition duration-300">üîÆ Pr√©diction</a>
                <a href="/comparaison" class="transform hover:scale-110 transition duration-300">üåê Comparaison</a>
            </div>
        </div>
    </footer>

    <script>
        // --- ELEMENTS DOM ---
        const uploadForm = document.getElementById('upload-form');
        const uploadBtn = document.getElementById('upload-btn');  
        const uploadText = document.getElementById('upload-text');
        const uploadSpinner = document.getElementById('upload-spinner');
        const previewCard = document.getElementById('df-preview-card'); 
        const redirectBtnContainer = document.getElementById('redirect-btn-container');    
        const messageContainer = document.getElementById('message-container');
        const previewDiv = document.getElementById('df-preview');
        const infoDiv = document.getElementById('df-info');
        const codeInput = document.getElementById('code-exp');
        const searchIconBtn = document.getElementById('search-icon-btn'); 
        const cityContainer = document.getElementById('city-input-container');
        const cityInput = document.getElementById('city-exp');
        const toggleCityBtn = document.getElementById('toggle-city-btn');
        const sidebarList = document.getElementById('sidebar-list');
        const geoStatus = document.getElementById('geo-status');
        
        const sidebarPanel = document.getElementById('sidebar-panel');
        const mainContent = document.getElementById('main-content');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');

        // --- GESTION DU TOGGLE LISTE ---
        toggleSidebarBtn.addEventListener('click', () => {
            sidebarPanel.classList.remove('hidden');
            sidebarPanel.classList.add('flex');
            mainContent.classList.remove('w-full');
            mainContent.classList.add('w-full', 'md:w-2/3', 'lg:w-3/4');
            toggleSidebarBtn.classList.add('hidden');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebarPanel.classList.add('hidden');
            sidebarPanel.classList.remove('flex');
            mainContent.classList.remove('md:w-2/3', 'lg:w-3/4');
            mainContent.classList.add('w-full');
            toggleSidebarBtn.classList.remove('hidden');
        });

        // --- FONCTIONS UTILITAIRES ---

        const displayMessage = (msg, type) => {
            messageContainer.textContent = msg;
            messageContainer.className = `mt-6 text-center text-lg font-medium ${type === 'error' ? 'text-red-500' : 'text-blue-600'}`;
        };

        const fetchCityName = async (lat, lon) => {
            const cacheKey = `geo_${lat}_${lon}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) return cached;

            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
                const response = await fetch(url, { headers: { 'User-Agent': 'PolluguardApp/1.0' } });
                if (!response.ok) return null;
                const data = await response.json();
                const addr = data.address || {};
                const city = addr.city || addr.town || addr.village || addr.municipality || "Lieu inconnu";
                localStorage.setItem(cacheKey, city);
                return city;
            } catch (e) {
                console.warn("Erreur Geocoding JS:", e);
                return null;
            }
        };

        // --- GESTION DE LA FILE D'ATTENTE G√âOCODAGE (CORRECTION DU BUG) ---
        const geocodingQueue = [];
        let isProcessingQueue = false;

        const processQueue = async () => {
            // Indicateur visuel
            isProcessingQueue = true;
            geoStatus.textContent = "üîÑ Recherche des villes...";

            // BOUCLE WHILE : Traite tant qu'il y a des √©l√©ments
            while (geocodingQueue.length > 0) {
                const item = geocodingQueue.shift();
                const { lat, lon, elementId, codeExp } = item;

                // Pause pour respecter les limites de l'API (1.1s)
                await new Promise(r => setTimeout(r, 1100));
                
                const city = await fetchCityName(lat, lon);
                
                // Mise √† jour de l'interface
                const el = document.getElementById(elementId);
                if (el && city) {
                    el.innerHTML = `<span class="font-bold text-yellow-300">${city}</span> <span class="text-white text-xs">(${codeExp})</span>`;
                    el.parentElement.classList.add('bg-white/20');
                    setTimeout(() => el.parentElement.classList.remove('bg-white/20'), 500);
                } else if (el) {
                    el.innerHTML = `<span class="text-white italic">Zone inconnue</span> <span class="text-white text-xs">(${codeExp})</span>`;
                }
            }

            // Fin du traitement
            isProcessingQueue = false;
            geoStatus.textContent = "‚úÖ Analyse termin√©e";
        };

        const addToGeocodingQueue = (lat, lon, elementId, codeExp) => {
            const cacheKey = `geo_${lat}_${lon}`;
            const cached = localStorage.getItem(cacheKey);
            
            if (cached) {
                // Si en cache, affichage imm√©diat
                const el = document.getElementById(elementId);
                if (el) el.innerHTML = `<span class="font-bold text-green-300">${cached}</span> <span class="text-white text-xs">(${codeExp})</span>`;
            } else {
                // Sinon ajout √† la file
                geocodingQueue.push({ lat, lon, elementId, codeExp });
                
                // Si la boucle ne tourne pas, on la lance
                if (!isProcessingQueue) {
                    processQueue();
                }
            }
        };

        // --- CHARGEMENT ---

        document.addEventListener('DOMContentLoaded', async () => {
            sidebarList.innerHTML = '<div class="text-center text-white/50 py-4">Chargement...</div>';

            try {
                const response = await fetch('/api/experiments');
                if (response.ok) {
                    const experiments = await response.json();
                    sidebarList.innerHTML = ''; 

                    experiments.forEach((exp, index) => {
                        const val = exp.CodeExp;
                        let villeAPI = exp.Ville || exp.City || exp.Name || exp.ville || exp.city || exp.name;
                        
                        // Sidebar Item
                        const sideItem = document.createElement('div');
                        sideItem.className = "p-3 rounded-lg bg-black/20 hover:bg-blue-600/30 transition-colors cursor-pointer border border-white/5 flex items-center justify-between group select-none";
                        const spanId = `geo-res-${index}`;
                        
                        let displayText = villeAPI 
                            ? `<span class="font-bold text-white">${villeAPI}</span> <span class="text-white text-xs">(${val})</span>`
                            : `<span class="text-white">${val}</span>`;

                        sideItem.innerHTML = `
                            <div class="flex flex-col">
                                <div id="${spanId}" class="text-sm">${displayText}</div>
                                <div class="text-[10px] text-gray-300 mt-0.5">Lat: ${exp.Latitude?.toFixed(2)}, Lon: ${exp.Longitude?.toFixed(2)}</div>
                            </div>
                            <span class="text-white opacity-0 group-hover:opacity-100 transition-opacity">‚Üí</span>
                        `;

                        // Clic (Simple ou Ctrl)
                        sideItem.addEventListener('click', (e) => {
                            if (e.ctrlKey || e.metaKey) {
                                let currentValues = codeInput.value.split(',').map(s => s.trim()).filter(s => s !== "");
                                if (currentValues.includes(val)) {
                                    currentValues = currentValues.filter(c => c !== val);
                                    sideItem.classList.add('bg-red-500/30');
                                    setTimeout(() => sideItem.classList.remove('bg-red-500/30'), 300);
                                } else {
                                    currentValues.push(val);
                                    sideItem.classList.add('bg-green-500/30');
                                    setTimeout(() => sideItem.classList.remove('bg-green-500/30'), 300);
                                }
                                codeInput.value = currentValues.join(', ');
                            } else {
                                codeInput.value = val;
                                codeInput.classList.add('ring-4', 'ring-blue-500');
                                setTimeout(() => codeInput.classList.remove('ring-4', 'ring-blue-500'), 300);
                            }
                            codeInput.focus();
                        });

                        sidebarList.appendChild(sideItem);

                        // Trigger Geocoding
                        if (!villeAPI && exp.Latitude && exp.Longitude) {
                            addToGeocodingQueue(exp.Latitude, exp.Longitude, spanId, val);
                        }
                    });
                }
            } catch (error) {
                console.error("Info: Impossible de charger la liste", error);
                sidebarList.innerHTML = '<div class="text-red-400 text-center">Erreur de chargement</div>';
            }
        });

        // --- GESTION FORMULAIRE (Code Existant) ---
        toggleCityBtn.addEventListener('click', () => { cityContainer.classList.toggle('hidden'); });
        searchIconBtn.addEventListener('click', () => {
            if (codeInput.value.trim() !== "") { uploadBtn.click(); } else { codeInput.focus(); }
        });
            
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const codeVal = codeInput.value.trim();
            if (!codeVal) { displayMessage('Veuillez entrer au moins un code exp√©rience.', 'error'); return; }
                        
            const formData = new FormData();
            formData.append('code_exp', codeVal);
            if (!cityContainer.classList.contains('hidden') && cityInput.value.trim() !== '') {
                formData.append('city_exp', cityInput.value.trim());
            }
            
            uploadBtn.disabled = true;
            uploadText.textContent = "Traitement en cours...";
            uploadSpinner.classList.remove('hidden');
            displayMessage('', 'info'); 
            
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const result = await response.json();
                
                if (response.ok) {
                    const customPreview = result.preview.replace(/<th>city<\/th>/gi, '<th>Villes</th>');
                    previewDiv.innerHTML = customPreview;
                    const cities = [...new Set(result.data_info.uploaded_files.map(f => f.city))].join(', ');
                    infoDiv.innerHTML = `
                        <p class="text-green-600 mb-2">‚úÖ <strong>Villes identifi√©es :</strong> ${cities}</p>
                        <p>üìä <strong>Total Lignes :</strong> ${result.data_info.rows}</p>
                        <p>üìã <strong>Total Colonnes :</strong> ${result.data_info.columns.length}</p>
                    `;
                    previewCard.classList.remove('hidden'); 
                    redirectBtnContainer.classList.remove('hidden');
                    displayMessage('', 'success');
                } else {
                    previewCard.classList.add('hidden');
                    redirectBtnContainer.classList.add('hidden');
                    displayMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur technique:', error);
                displayMessage('Erreur de communication avec le serveur.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadText.textContent = "Charger les Donn√©es";
                uploadSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>