<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charger Donn√©es</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed top-0 left-0 w-full z-10 p-4 top-nav">
    <div class="container mx-auto flex justify-between items-center relative h-10">
        <a href="/" class="h-10 flex items-center z-10">
             <img src="static/images/logo.png" alt="Logo Eurosmart Analytics" class="h-12">
        </a>
        <a href="/" class="h-10 flex items-center justify-end z-10">
             <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
        </a>
    </div>
    </nav>

    <main class="container mx-auto p-8 flex-grow">
        <h1 class="text-3xl md:text-4xl font-extrabold mb-4 text-white text-center">Acc√©der aux Exp√©riences</h1>

        <div class="main-card p-6 md:p-10 text-center">
            
            <form id="upload-form" class="space-y-6 max-w-2xl mx-auto">
                
                <div class="text-left">
                    <label for="code-exp" class="block text-gray-700 font-bold mb-2 text-lg">
                        Codes Exp√©rience
                    </label>
                    <div class="relative">
                        <input type="text" 
                               id="code-exp" 
                               name="code_exp" 
                               list="experiments-list"
                               placeholder="Ex: EVRY_2025, PARIS_2024..." 
                               class="w-full p-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-gray-800 text-lg shadow-sm transition-all"
                               autocomplete="off">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <span class="text-gray-400 text-xl">üîç</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Vous pouvez saisir plusieurs codes s√©par√©s par des virgules.</p>
                    
                    <datalist id="experiments-list"></datalist>

                    <div class="mt-4">
                        <button type="button" id="toggle-city-btn" class="text-blue-600 text-sm hover:underline focus:outline-none flex items-center">
                            <span>üìç La ville n'est pas d√©tect√©e ? Cliquez ici pour la saisir manuellement.</span>
                        </button>
                    </div>

                    <div id="city-input-container" class="hidden mt-3 transition-all duration-300 bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <label for="city-exp" class="block text-sm text-blue-800 font-semibold mb-1">
                            Ville par d√©faut (Optionnel)
                        </label>
                        <input type="text" 
                               id="city-exp" 
                               name="city_exp" 
                               placeholder="Ex: Evry" 
                               class="w-full p-2 border border-blue-300 rounded bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        <p class="text-xs text-blue-600 mt-1">Cette ville sera utilis√©e si le syst√®me n'arrive pas √† la deviner via le code ou le GPS.</p>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" id="upload-btn" class="btn-gradient w-full py-3 text-lg font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center">
                        <span id="upload-text">Charger les Donn√©es</span>
                        <div id="upload-spinner" class="hidden w-5 h-5 border-2 border-white border-opacity-50 rounded-full animate-spin ml-2"></div>
                    </button>
                </div>
            </form>

            <div id="message-container" class="mt-6 text-center text-lg font-medium"></div>

        </div>

        <div id="df-preview-card" class="main-card p-6 md:p-10 text-center mt-8 hidden">
            <div id="df-info" class="text-left text-gray-700 mb-4 font-semibold"></div>
            <div class="table-preview">
                <div id="df-preview" class="text-sm"></div>
            </div>
            <div id="redirect-btn-container" class="mt-6 flex flex-wrap gap-4 justify-center hidden">
                <a href="/data-preparation" class="btn-gradient w-full md:w-auto">Aller √† la page de Nettoyage ‚Üí</a>
            </div>
        </div>
    </main>

     <footer class="footer-transparent text-gray-400 p-4 mt-8 text-center">
        <div class="container mx-auto">
            <div class="flex justify-center items-center space-x-6 text-2xl mb-4">
                <a href="/" class="transform hover:scale-110 transition duration-300">‚ú® Accueil</a>
                <a href="/upload-data" class="transform hover:scale-110 transition duration-300">üìÅ Chargement</a>
                <a href="/data-preparation" class="transform hover:scale-110 transition duration-300">üßº Nettoyage</a>
                <a href="/visualizations" class="transform hover:scale-110 transition duration-300">üìà Visualisation</a>
                <a href="/prediction-modeling" class="transform hover:scale-110 transition duration-300">üîÆ Pr√©diction</a>
                <a href="/comparaison" class="transform hover:scale-110 transition duration-300">üåê Comparaison</a>
            </div>
        </div>
    </footer>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const uploadBtn = document.getElementById('upload-btn');  
        const uploadText = document.getElementById('upload-text');
        const uploadSpinner = document.getElementById('upload-spinner');
        const previewCard = document.getElementById('df-preview-card'); 
        const redirectBtnContainer = document.getElementById('redirect-btn-container');    
        const messageContainer = document.getElementById('message-container');
        const previewDiv = document.getElementById('df-preview');
        const infoDiv = document.getElementById('df-info');
        const codeInput = document.getElementById('code-exp');
        const dataList = document.getElementById('experiments-list');
        const cityContainer = document.getElementById('city-input-container');
        const cityInput = document.getElementById('city-exp');
        const toggleCityBtn = document.getElementById('toggle-city-btn');

        const displayMessage = (msg, type) => {
            messageContainer.textContent = msg;
            messageContainer.className = `mt-6 text-center text-lg font-medium ${type === 'error' ? 'text-red-500' : 'text-blue-600'}`;
        };

        // 1. Charger la liste des exp√©riences (pour l'autocompl√©tion si dispo)
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/experiments');
                if (response.ok) {
                    const experiments = await response.json();
                    experiments.forEach(exp => {
                        const option = document.createElement('option');
                        option.value = exp.CodeExp;
                        option.label = `Lat: ${exp.Latitude}, Lon: ${exp.Longitude}`; 
                        dataList.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Info: Impossible de charger la liste d'autocompl√©tion (pas grave)", error);
            }
        });

        // 2. Gestion du bouton pour afficher le champ ville manuel
        toggleCityBtn.addEventListener('click', () => {
            cityContainer.classList.toggle('hidden');
        });
            
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const codeVal = codeInput.value.trim();

            if (!codeVal) {
                displayMessage('Veuillez entrer au moins un code exp√©rience.', 'error');
                return;
            }
                        
            const formData = new FormData();
            formData.append('code_exp', codeVal);
            
            // On envoie la ville manuelle si elle est saisie
            if (!cityContainer.classList.contains('hidden') && cityInput.value.trim() !== '') {
                formData.append('city_exp', cityInput.value.trim());
            }
            
            uploadBtn.disabled = true;
            uploadText.textContent = "Traitement en cours...";
            uploadSpinner.classList.remove('hidden');
            displayMessage('', 'info'); 
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                
                if (response.ok) {
                    // Remplacement du header "city" par "Villes" dans l'affichage du tableau
                    // Utilisation d'une regex insensible √† la casse (/gi)
                    const customPreview = result.preview.replace(/<th>city<\/th>/gi, '<th>Villes</th>');
                    previewDiv.innerHTML = customPreview;
                    
                    // Liste des villes d√©tect√©es
                    const cities = [...new Set(result.data_info.uploaded_files.map(f => f.city))].join(', ');
                    
                    infoDiv.innerHTML = `
                        <p class="text-green-600 mb-2">‚úÖ <strong>Villes identifi√©es :</strong> ${cities}</p>
                        <p>üìä <strong>Total Lignes :</strong> ${result.data_info.rows}</p>
                        <p>üìã <strong>Total Colonnes :</strong> ${result.data_info.columns.length}</p>
                    `;
                    
                    previewCard.classList.remove('hidden'); 
                    redirectBtnContainer.classList.remove('hidden');
                    displayMessage('', 'success');
            
                } else {
                    previewCard.classList.add('hidden');
                    redirectBtnContainer.classList.add('hidden');
                    displayMessage(result.error, 'error');
                }
            } catch (error) {
                console.error('Erreur technique:', error);
                displayMessage('Erreur de communication avec le serveur.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadText.textContent = "Charger les Donn√©es";
                uploadSpinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>