<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation - Eurosmart Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #a742b7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Override sp√©cifique pour correspondre au style bouton "Analyse" */
        .btn-gradient {
            background: linear-gradient(135deg, #a742b7, #4b52ff, #ff69b4);
            color: white;
            font-weight: bold;
            border-radius: 9999px;
            border: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
        }
        .btn-gradient:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed top-0 left-0 w-full z-50 p-4 top-nav backdrop-blur-md shadow-md">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center">
                 <img src="static/images/logo.png" alt="Logo Eurosmart" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 flex-grow mb-20 mt-20"> 
``` <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-white text-center">Visualisation des Donn√©es</h1> <div id="selection-card" class="main-card p-6 md:p-10 text-center max-w-[95%] mx-auto bg-white rounded-[2rem]"> <h2 class="text-2xl font-bold mb-8 text-gray-800">Configuration du Graphique</h2> <form id="plot-form" class="space-y-8"> <div class="grid grid-cols-1 md:grid-cols-2 gap-8"> <div class="text-left"> <label for="plotType" class="block text-gray-700 font-bold mb-2 ml-1">Type de Graphique</label> ```
                        <select id="plotType" name="plotType" class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-purple-500 outline-none bg-gray-50 text-gray-700">
                            <option value="line">Lignes</option>
                            <option value="bar">Barres</option>
                            <option value="scatter">Nuage de points</option>
                            <option value="box">Bo√Æte √† moustaches</option>
                            <option value="distribution_histogram">Histogramme</option>
                            <option value="pie">Secteurs</option>
                        </select>
                    </div>
                    <div id="x-col-container" class="text-left">
                        <label for="xCol" class="block text-gray-700 font-bold mb-2 ml-1">Variable Axe X</label>
                        <select id="xCol" name="xCol" class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-purple-500 outline-none bg-gray-50 text-gray-700"></select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div id="y-col-container" class="text-left">
                        <label for="yCol" class="block text-gray-700 font-bold mb-2 ml-1">Variable Axe Y</label>
                        <select id="yCol" name="yCol" class="w-full p-3 border-2 border-gray-100 rounded-xl focus:border-purple-500 outline-none bg-gray-50 text-gray-700"></select>
                    </div>
                    <div id="color-col-container" class="text-left">
                        <label for="colorCol" class="block text-gray-700 font-bold mb-2 ml-1">Colorer par</label>
                        <select id="colorCol" name="colorCol" class="w-full p-3 border-2 border-gray-100 rounded-xl focus:border-purple-500 outline-none bg-gray-50 text-gray-700"></select>
                    </div>
                    <div id="color-type-container" class="text-left">
                        <label for="colorType" class="block text-gray-700 font-bold mb-2 ml-1">Seuils</label>
                        <select id="colorType" name="colorType" class="w-full p-3 border-2 border-gray-100 rounded-xl focus:border-purple-500 outline-none bg-gray-50 text-gray-700"></select>
                    </div>
                    <div id="city-filter-container" class="text-left">
                        <label for="city-filter" class="block text-gray-700 font-bold mb-2 ml-1">Filtrer Ville</label>
                        <select id="city-filter" name="city-filter" class="w-full p-3 border-2 border-gray-100 rounded-xl focus:border-purple-500 outline-none bg-gray-50 text-gray-700">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-gradient px-12 py-4 text-lg shadow-xl inline-flex items-center">
                    G√©n√©rer le graphique
                </button>
            </form>
        </div>
        
        <div id="plot-card" class="main-card p-6 md:p-8 mt-12 hidden max-w-[95%] mx-auto bg-white rounded-[2rem]">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Analyse Graphique</h2>
            <div id="message-container" class="mb-4 text-lg font-medium"></div>
            
            <div class="bg-gray-50 rounded-[2rem] border-4 border-gray-100 overflow-hidden shadow-inner">
                <div id="plot-container" class="w-full min-h-[600px]"></div>
            </div>

            <div id="analysis-trigger-container" class="mt-10 hidden">
                <button id="trigger-analysis-btn" class="btn-gradient px-10 py-4 text-lg shadow-xl flex items-center mx-auto">
                    Lancer l'Analyse 
                </button>
            </div>


            <div id="analysis-results" class="mt-12 text-left w-full hidden space-y-8 animate-fade-in-up"></div>

            <div id="redirect-btn-container" class="mt-12 pt-8 border-t border-gray-100 flex flex-wrap justify-center gap-4 hidden">
                <button id="downloadPlotBtn" class="btn-gradient px-8 py-3 text-sm">üì∏ Enregistrer l'image</button>
                <button onclick="window.location.href='/prediction-modeling'" class="btn-gradient px-8 py-3 text-sm">üîÆ Voir les Pr√©dictions</button>
            </div>
        </div>
    </main>

    <footer class="footer-transparent text-gray-400 p-6 mt-8 text-center">
        <div class="container mx-auto flex flex-wrap justify-center gap-6">
            <a href="/" class="nav-link">‚ú® Accueil</a>
            <a href="/upload-data" class="nav-link">üìÅ Chargement</a>
            <a href="/prediction-modeling" class="nav-link">üîÆ Pr√©diction</a>
            <a href="/visualizations" class="nav-link">üìà Visualisation</a>
            <a href="/comparaison" class="nav-link">üåê Comparaison</a>
        </div>
    </footer>

    <script>
        // Logique JS (identique √† la tienne, simplifi√©e pour les messages)
        const messageContainer = document.getElementById('message-container');
        const plotForm = document.getElementById('plot-form');
        const plotContainer = document.getElementById('plot-container');
        const xColSelect = document.getElementById('xCol');
        const yColSelect = document.getElementById('yCol');
        const colorColSelect = document.getElementById('colorCol');
        const colorTypeSelect = document.getElementById('colorType');
        const plotTypeSelect = document.getElementById('plotType');
        const cityFilterSelect = document.getElementById('city-filter');
        const redirectBtnContainer = document.getElementById('redirect-btn-container');
        const downloadPlotBtn = document.getElementById('downloadPlotBtn');
        const analysisBtnContainer = document.getElementById('analysis-trigger-container');
        const analysisBtn = document.getElementById('trigger-analysis-btn');
        const analysisResults = document.getElementById('analysis-results');
        
        let allColumns = []; 
        let timeColumns = []; 
        let currentPollutant = null;

        const columnTypeMapping = {
            'temp': { value: 'temperature', text: 'Temp√©rature' }, 
            'hum': { value: 'humidity', text: 'Humidit√©' }, 
            'cov': { value: 'cov', text: 'Qualit√© Air (COV)' },
            'pm': { value: 'pm', text: 'Particules Fines' },
            'co2': { value: 'co2', text: 'Dioxyde de Carbone' }
        };

        const runAnalysis = async () => {
            if (!currentPollutant) return;
            analysisResults.classList.remove('hidden');
            analysisResults.innerHTML = `
                <div class="flex flex-col items-center justify-center p-12">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-purple-600 font-bold animate-pulse">L'IA d√©chiffre vos donn√©es...</p>
                </div>`;
            
            try {
                const response = await fetch('/analyze_peaks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pollutant: currentPollutant })
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                
                let html = '';
                if (data.knowledge && data.knowledge.desc) {
                    html += `
                        <div class="bg-white rounded-[2rem] shadow-xl p-8 border border-purple-50 mb-8 relative">
                            <h3 class="text-2xl font-bold text-purple-800 mb-4 flex items-center">üîç ${data.pollutant}</h3>
                            <p class="text-gray-600 text-lg leading-relaxed mb-6">${data.knowledge.desc}</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-rose-50 p-6 rounded-2xl"><b class="text-rose-600">Hausse :</b> ${data.knowledge.hausse}</div>
                                <div class="bg-emerald-50 p-6 rounded-2xl"><b class="text-emerald-600">Baisse :</b> ${data.knowledge.baisse}</div>
                            </div>
                        </div>`;
                }

                Object.keys(data.analysis).forEach(cityName => {
                    const cityData = data.analysis[cityName];
                    html += `
                        <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden mb-8 border border-gray-100">
                            <div class="bg-gray-900 p-6 text-white flex justify-between items-center">
                                <h4 class="text-2xl font-bold uppercase tracking-wider">${cityName}</h4>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400 block">Moyenne</span>
                                    <span class="text-2xl font-mono">${cityData.stats.avg}</span>
                                </div>
                            </div>
                            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <h5 class="font-bold text-rose-500">üìà √âpisodes de Pics</h5>
                                    ${cityData.peaks.map(p => `<div class="p-4 bg-rose-50 rounded-2xl text-sm"><b>${p.time}</b> : ${p.explanation}</div>`).join('')}
                                </div>
                                <div class="space-y-4">
                                    <h5 class="font-bold text-emerald-500">üìâ Points de Baisse</h5>
                                    ${cityData.troughs.map(t => `<div class="p-4 bg-emerald-50 rounded-2xl text-sm"><b>${t.time}</b> : ${t.explanation}</div>`).join('')}
                                </div>
                            </div>
                        </div>`;
                });
                analysisResults.innerHTML = html;
            } catch (e) {
                analysisResults.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-xl">Analyse indisponible pour ce capteur.</div>`;
            }
        };

        analysisBtn.addEventListener('click', runAnalysis);

        // --- FETCH & UI ---
        const populateSelect = (select, options, includeEmpty = false, emptyText = 'Toutes') => {
            select.innerHTML = '';
            if (includeEmpty) {
                const opt = document.createElement('option');
                opt.value = ""; opt.textContent = emptyText;
                select.appendChild(opt);
            }
            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.textContent = o;
                select.appendChild(opt);
            });
        };

        const fetchDataFrameInfo = async () => {
            const res = await fetch('/get_data_info');
            const data = await res.json();
            if (res.ok) {
                allColumns = data.data_info.columns;
                timeColumns = allColumns.filter(col => ['date', 'heure', 'temps'].some(k => col.toLowerCase().includes(k)));
                populateSelect(yColSelect, allColumns.filter(c => !timeColumns.includes(c)));
                updateXColOptions();
            }
        };

        const updateXColOptions = () => {
            if (['line', 'bar'].includes(plotTypeSelect.value) && timeColumns.length > 0) {
                populateSelect(xColSelect, [timeColumns[0]]);
                xColSelect.disabled = true;
            } else {
                populateSelect(xColSelect, allColumns.filter(c => !timeColumns.includes(c)));
                xColSelect.disabled = false;
            }
            populateSelect(colorColSelect, ["", ...allColumns.filter(c => !timeColumns.includes(c))], false, "Aucun");
        };

        plotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                plotType: plotTypeSelect.value,
                xCol: xColSelect.value,
                yCol: yColSelect.value,
                colorCol: colorColSelect.value,
                colorType: colorTypeSelect.value,
                city: cityFilterSelect.value
            };
            document.getElementById('plot-card').classList.remove('hidden');
            messageContainer.innerHTML = '<div class="loading-spinner mx-auto"></div>';

            const res = await fetch('/generate_plot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                Plotly.newPlot('plot-container', JSON.parse(data.plot_json).data, JSON.parse(data.plot_json).layout, {responsive: true});
                messageContainer.innerHTML = '';
                redirectBtnContainer.classList.remove('hidden');
                if (payload.yCol) { currentPollutant = payload.yCol; analysisBtnContainer.classList.remove('hidden'); }
            }
        });

        const fetchUniqueCities = async () => {
            const res = await fetch('/get_unique_cities');
            const data = await res.json();
            if (res.ok) populateSelect(cityFilterSelect, data.cities, true);
        };

        document.addEventListener('DOMContentLoaded', () => { fetchDataFrameInfo(); fetchUniqueCities(); });
        plotTypeSelect.addEventListener('change', updateXColOptions);
        downloadPlotBtn.addEventListener('click', () => Plotly.downloadImage('plot-container', {format: 'png', filename: 'polluguard_export'}));
    </script>
</body>
</html>