<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation - Eurosmart Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed top-0 left-0 w-full z-10 p-4 top-nav">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center z-10">
                 <img src="static/images/logo.png" alt="Logo Eurosmart Analytics" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end z-10">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>

    <main class="container mx-auto p-8 flex-grow mb-20"> 
        <h1 class="text-3xl md:text-4xl font-extrabold mb-4 text-white text-center">Visualisation des Donn√©es</h1>
        
        <!-- CARTE DE S√âLECTION -->
        <div id="selection-card" class="main-card p-6 md:p-10 text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Configuration</h2>
            <form id="plot-form" class="space-y-4">
                <div class="flex flex-col md:flex-row md:space-x-4 md:space-y-0 space-y-4">
                    <div class="flex-1">
                        <label for="plotType" class="block text-left text-gray-700 font-bold mb-2">Type de Graphique</label>
                        <select id="plotType" name="plotType" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="line">Lignes</option>
                            <option value="bar">Barres</option>
                            <option value="scatter">Nuage de points</option>
                            <option value="box">Bo√Æte √† moustaches</option>
                            <option value="distribution_histogram">Histogramme de distribution</option>
                            <option value="pie">Secteurs</option>
                        </select>
                    </div>
                    <div id="x-col-container" class="flex-1">
                        <label for="xCol" class="block text-left text-gray-700 font-bold mb-2">Variable en X</label>
                        <select id="xCol" name="xCol" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row md:space-x-4 md:space-y-0 space-y-4">
                    <div id="y-col-container" class="flex-1">
                        <label for="yCol" class="block text-left text-gray-700 font-bold mb-2">Variable en Y</label>
                        <select id="yCol" name="yCol" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div id="color-col-container" class="flex-1">
                        <label for="colorCol" class="block text-left text-gray-700 font-bold mb-2">Variable √† colorer</label>
                        <select id="colorCol" name="colorCol" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div id="color-type-container" class="flex-1">
                        <label for="colorType" class="block text-left text-gray-700 font-bold mb-2">Variable √† cat√©goriser</label>
                        <select id="colorType" name="colorType" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div id="city-filter-container" class="flex-1">
                        <label for="city-filter" class="block text-left text-gray-700 font-bold mb-2">Choix de la Ville</label>
                        <select id="city-filter" name="city-filter" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tous les villes</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-gradient w-full md:w-auto mt-6">G√©n√©rer le graphique</button>
            </form>
        </div>
        
        <!-- CARTE DE R√âSULTAT -->
        <div id="plot-card" class="main-card p-6 md:p-10 text-center mt-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">R√©sultat</h2>
            <div id="message-container" class="mt-4 text-center text-lg"></div>
            
            <div class="plot-container-wrapper">
                <div id="plot-container" class="w-full h-96"></div>
            </div>

            <!-- BOUTON D'ANALYSE (Style harmonis√©) -->
            <div id="analysis-trigger-container" class="mt-8 hidden">
                <button id="trigger-analysis-btn" class="btn-gradient flex items-center justify-center mx-auto text-lg">
                    <span class="mr-2">üîç</span> Lancer l'analyse des Causes & Pics
                </button>
            </div>

            <!-- ZONE DE R√âSULTATS ANALYSE (Structure modifi√©e) -->
            <div id="analysis-results" class="mt-12 text-left max-w-6xl mx-auto hidden transition-all duration-500 space-y-8">
                <!-- Injection JS ici -->
            </div>

            <div id="redirect-btn-container" class="mt-6 flex flex-wrap gap-4 justify-center hidden">
                <button id="downloadPlotBtn" class="btn-gradient">T√©l√©charger le graphique </button>
                <button onclick="window.location.href='/prediction-modeling'" class="btn-gradient">Aller √† la page Pr√©diction</button>
            </div>
        </div>
    </main>

    <footer class="footer-transparent text-gray-400 p-4 mt-8 text-center"></footer>

    <script>
        // --- VARIABLES ---
        const messageContainer = document.getElementById('message-container');
        const plotForm = document.getElementById('plot-form');
        const plotContainer = document.getElementById('plot-container');
        const xColSelect = document.getElementById('xCol');
        const yColSelect = document.getElementById('yCol');
        const colorColSelect = document.getElementById('colorCol');
        const colorTypeSelect = document.getElementById('colorType');
        const plotTypeSelect = document.getElementById('plotType');
        const cityFilterSelect = document.getElementById('city-filter');
        const redirectBtnContainer = document.getElementById('redirect-btn-container');
        const downloadPlotBtn = document.getElementById('downloadPlotBtn');
        
        const analysisBtnContainer = document.getElementById('analysis-trigger-container');
        const analysisBtn = document.getElementById('trigger-analysis-btn');
        const analysisResults = document.getElementById('analysis-results');
        
        let allColumns = []; 
        let timeColumns = []; 
        let currentPollutant = null;

        // Mappage des noms de colonnes pour la coloration automatique
        const columnTypeMapping = {
            'temp': { value: 'temperature', text: 'Temp√©rature' }, 
            'hum': { value: 'humidity', text: 'Humidit√©' }, 
            'cov': { value: 'cov', text: 'COV' },
            'iqa': { value: 'iqa', text: 'IQA' },
            'pm': { value: 'pm', text: 'Particules' },
            'co2': { value: 'co2', text: 'CO2' },
            'nox': { value: 'nox', text: 'NOx' },
            'lum': { value: 'light', text: 'Luminosit√©' }, 
        };

        // --- FONCTION D'ANALYSE (Style harmonis√©) ---
        const runAnalysis = async () => {
            if (!currentPollutant) return;
            
            analysisResults.classList.remove('hidden');
            analysisResults.innerHTML = '<div class="flex flex-col items-center justify-center p-12"><div class="loading-spinner mb-4 border-gray-400 border-l-blue-600"></div><p class="text-blue-600 font-semibold">Analyse en cours...</p></div>';
            
            try {
                const response = await fetch('/analyze_peaks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pollutant: currentPollutant })
                });
                const data = await response.json();
                
               
                let html = `
                    <!-- BLOC 1 : TH√âORIE (Causes Probables G√©n√©rales) -->
                    <div class="bg-white text-black rounded-[2rem] shadow-[0_10px_30px_rgba(255,105,180,0.2)] overflow-hidden transition-transform duration-500 hover:-translate-y-1">
                        <div class="bg-gray-50 px-8 py-5 border-b border-gray-100">
                            <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#a742b7] to-[#ff69b4] flex items-center">
                                Comprendre le param√®tre : <span class="ml-2 text-gray-700">${data.pollutant}</span>
                            </h3>
                            <p class="text-sm text-gray-600 mt-2 italic">${data.knowledge.desc}</p>
                        </div>
                        <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold text-red-500 mb-4 flex items-center text-lg">
                                    <span class="bg-red-100 p-1.5 rounded-lg mr-2 text-sm">‚ñ≤</span> Facteurs de Hausse
                                </h4>
                                <p class="text-gray-700 leading-relaxed text-sm bg-gray-50 p-5 rounded-2xl border border-red-50 shadow-sm h-full">
                                    ${data.knowledge.hausse}
                                </p>
                            </div>
                            <div>
                                <h4 class="font-bold text-green-500 mb-4 flex items-center text-lg">
                                    <span class="bg-green-100 p-1.5 rounded-lg mr-2 text-sm">‚ñº</span> Facteurs de Baisse
                                </h4>
                                <p class="text-gray-700 leading-relaxed text-sm bg-gray-50 p-5 rounded-2xl border border-green-50 shadow-sm h-full">
                                    ${data.knowledge.baisse}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- BLOC 2 : PRATIQUE (Analyse des Donn√©es R√©elles) -->
                    <div class="bg-white text-black rounded-[2rem] shadow-[0_10px_30px_rgba(255,105,180,0.2)] overflow-hidden transition-transform duration-500 hover:-translate-y-1">
                        <div class="bg-gray-50 px-8 py-5 border-b border-gray-100">
                            <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#a742b7] to-[#ff69b4] flex items-center">
                                üìä Analyse du graphe
                            </h3>
                        </div>
                        <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                            
                            <!-- PICS (Valeurs Hautes) -->
                            <div>
                                <h4 class="font-bold text-red-500 mb-4 border-b-2 border-red-100 pb-2 text-lg">Pics les plus √©lev√©s</h4>
                                ${data.peaks.length > 0 ? data.peaks.map(p => `
                                    <div class="mb-4 bg-red-50 p-4 rounded-2xl border-l-4 border-red-400 shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-mono text-xs text-gray-500 bg-white px-2 py-1 rounded-lg border border-gray-100">${p.time}</span>
                                            <span class="font-bold text-red-600 text-xl">${p.value}</span>
                                        </div>
                                        <p class="text-sm text-gray-700 italic flex items-start">
                                            <span class="mr-2">üí°</span> ${p.context}
                                        </p>
                                    </div>
                                `).join('') : '<p class="text-gray-400 italic text-center py-4">Aucune donn√©e significative.</p>'}
                            </div>

                            <!-- CREUX (Valeurs Basses) -->
                            <div>
                                <h4 class="font-bold text-green-500 mb-4 border-b-2 border-green-100 pb-2 text-lg">Creux les plus bas</h4>
                                ${data.troughs.length > 0 ? data.troughs.map(t => `
                                    <div class="mb-4 bg-green-50 p-4 rounded-2xl border-l-4 border-green-400 shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-mono text-xs text-gray-500 bg-white px-2 py-1 rounded-lg border border-gray-100">${t.time}</span>
                                            <span class="font-bold text-green-600 text-xl">${t.value}</span>
                                        </div>
                                        <p class="text-sm text-gray-700 italic flex items-start">
                                            <span class="mr-2">üí°</span> ${t.context}
                                        </p>
                                    </div>
                                `).join('') : '<p class="text-gray-400 italic text-center py-4">Aucune donn√©e significative.</p>'}
                            </div>
                        </div>
                    </div>
                `;
                
                analysisResults.innerHTML = html;
                // Scroll automatique vers les r√©sultats
                analysisResults.scrollIntoView({behavior: 'smooth', block: 'start'});
                
            } catch (e) {
                console.error(e);
                analysisResults.innerHTML = '<p class="text-red-500 text-center bg-red-50 p-4 rounded-xl">Erreur technique lors de l\'analyse.</p>';
            }
        };

        analysisBtn.addEventListener('click', runAnalysis);

        // --- FONCTIONS UTILITAIRES GRAPHIQUE ---

        const normalizeString = (str) => {
            if (!str) return '';
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, ''); 
        };

        const displayMessage = (msg, type) => {
            if (type === 'success') { messageContainer.textContent = ''; } 
            else { 
                messageContainer.textContent = msg; 
                messageContainer.style.color = (type === 'error') ? '#ff4d4d' : 'black'; 
            }
        };

        const populateSelect = (selectElement, options, includeEmpty = false, emptyText = 'S√©lectionnez...') => {
            selectElement.innerHTML = '';
            if (includeEmpty) {
                const emptyOption = document.createElement('option');
                emptyOption.value = "";
                emptyOption.textContent = emptyText;
                selectElement.appendChild(emptyOption);
            }
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        };

        const fetchDataFrameInfo = async () => {
            try {
                const response = await fetch('/get_data_info');
                const result = await response.json();
                if (response.ok) {
                    allColumns = result.data_info.columns;
                    timeColumns = allColumns.filter(col => 
                        normalizeString(col).includes('date') || 
                        normalizeString(col).includes('heure') ||
                        normalizeString(col).includes('temps')
                    );
                    const nonTimeColumns = allColumns.filter(col => !timeColumns.includes(col));
                    populateSelect(yColSelect, nonTimeColumns);
                    updateXColOptions();
                    updateColorColOptions();
                } else { displayMessage(result.error, 'error'); }
            } catch (error) { displayMessage('Erreur chargement colonnes.', 'error'); }
        };

        const fetchUniqueCities = async () => {
            try {
                const response = await fetch('/get_unique_cities');
                const result = await response.json();
                if (response.ok && result.cities) {
                    populateSelect(cityFilterSelect, result.cities, true, 'Toutes les villes');
                } else { document.getElementById('city-filter-container').style.display = 'none'; }
            } catch (error) { document.getElementById('city-filter-container').style.display = 'none'; }
        };

        const updateXColOptions = () => {
            const plotType = plotTypeSelect.value;
            const xColContainer = document.getElementById('x-col-container');
            const isTimeSeries = ['line', 'bar'].includes(plotType);
            xColSelect.innerHTML = ''; xColSelect.disabled = false;
            
            if (isTimeSeries) {
                if (timeColumns.length > 0) {
                    const timeColName = timeColumns[0];
                    populateSelect(xColSelect, [timeColName], false, timeColName);
                    xColSelect.disabled = true; 
                } else {
                    populateSelect(xColSelect, ['Date/Heure non trouv√©e']);
                    xColSelect.disabled = true;
                }
            } else {
                const nonTimeColumns = allColumns.filter(col => !timeColumns.includes(col));
                if (['pie', 'box', 'scatter'].includes(plotType)) { populateSelect(xColSelect, nonTimeColumns); } 
                else { populateSelect(xColSelect, allColumns); }
            }
            updateColorColOptions();
        };
        
        const updateColorColOptions = () => {
            const plotType = plotTypeSelect.value;
            const xCol = xColSelect.value;
            const yCol = yColSelect.value;
            const options = [{ value: "", text: "Aucun" }];
            const isTimeSeriesPlot = ['line'].includes(plotType); 
            
            if (xCol && xCol !== 'Date/Heure non trouv√©e' && !isTimeSeriesPlot && !timeColumns.includes(xCol)) {
                options.push({ value: xCol, text: xCol });
            }
            if (['scatter', 'bar', 'pie'].includes(plotType) && yCol && yCol !== xCol && !timeColumns.includes(yCol)) {
                options.push({ value: yCol, text: yCol });
            }
            if (['pie', 'box', 'distribution_histogram'].includes(plotType) && xCol && xCol !== 'Date/Heure non trouv√©e' && !timeColumns.includes(xCol)) {
                if (!options.some(opt => opt.value === xCol)) options.push({ value: xCol, text: xCol });
            }

            colorColSelect.innerHTML = '';
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt.value; el.textContent = opt.text;
                colorColSelect.appendChild(el);
            });
            updateColorTypeOptions();
        };

        const togglePlotOptions = () => {
            const plotType = plotTypeSelect.value;
            updateXColOptions();
            document.getElementById('y-col-container').style.display = ['pie', 'box', 'distribution_histogram'].includes(plotType) ? 'none' : 'block';
            const hideColor = ['distribution_histogram', 'box', 'line'].includes(plotType);
            document.getElementById('color-col-container').style.display = hideColor ? 'none' : 'block';
            document.getElementById('color-type-container').style.display = hideColor ? 'none' : 'block';
            updateColorColOptions();
        };

        const updateColorTypeOptions = () => {
            const selectedCol = colorColSelect.value;
            colorTypeSelect.innerHTML = '';
            const emptyOption = document.createElement('option');
            emptyOption.value = "none"; emptyOption.textContent = "Aucun"; 
            colorTypeSelect.appendChild(emptyOption);

            if (selectedCol) {
                const normalizedCol = normalizeString(selectedCol);
                const colKey = Object.keys(columnTypeMapping).find(key => normalizedCol.includes(key));
                if (colKey) {
                    const mappedType = columnTypeMapping[colKey];
                    const opt = document.createElement('option');
                    opt.value = mappedType.value; opt.textContent = mappedType.text;
                    colorTypeSelect.appendChild(opt);
                    colorTypeSelect.value = mappedType.value;
                }
            } else { colorTypeSelect.value = "none"; }
        };

        plotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('plot-card').classList.remove('hidden');
            analysisBtnContainer.classList.add('hidden'); // Reset bouton analyse
            analysisResults.classList.add('hidden'); // Reset r√©sultats
            
            const plotType = plotTypeSelect.value;
            const xCol = xColSelect.value;
            const plotsWithoutColorGrouping = ['distribution_histogram', 'box', 'line'];
            const yCol = ['pie', 'box', 'distribution_histogram'].includes(plotType) ? "" : yColSelect.value;
            const colorCol = plotsWithoutColorGrouping.includes(plotType) ? "" : colorColSelect.value;
            const colorType = plotsWithoutColorGrouping.includes(plotType) ? "none" : colorTypeSelect.value;
            const city = cityFilterSelect.value;
            
            if (!xCol || xCol === 'Date/Heure non trouv√©e') { displayMessage('S√©lectionnez un axe X valide.', 'error'); return; }
            if (['scatter', 'bar', 'line'].includes(plotType) && !yCol) { displayMessage('S√©lectionnez un axe Y.', 'error'); return; }

            displayMessage('G√©n√©ration...', 'info');

            try {
                const response = await fetch('/generate_plot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plotType, xCol, yCol, colorCol, colorType, city }),
                });

                const result = await response.json();
                
                if (response.ok) {
                    const plotData = JSON.parse(result.plot_json);
                    Plotly.newPlot('plot-container', plotData.data, plotData.layout, { responsive: true });
                    displayMessage('', 'success'); 
                    redirectBtnContainer.classList.remove('hidden');

                    // --- DETECTION POLLUANT POUR ANALYSE ---
                    if (yCol) {
                        currentPollutant = yCol; // Sauvegarde pour le bouton
                        analysisBtnContainer.classList.remove('hidden');
                    }
                } else {
                    displayMessage(result.error, 'error');
                    plotContainer.innerHTML = '<p class="text-gray-500">Erreur de g√©n√©ration.</p>';
                }
            } catch (error) { displayMessage('Erreur inattendue.', 'error'); }
        });

        downloadPlotBtn.addEventListener('click', () => {
            Plotly.downloadImage('plot-container', { format: 'png', filename: 'graphique_eurosmart' });
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchDataFrameInfo();
            fetchUniqueCities();
            togglePlotOptions();
        });

        plotTypeSelect.addEventListener('change', togglePlotOptions);
        xColSelect.addEventListener('change', updateColorColOptions);
        yColSelect.addEventListener('change', updateColorColOptions);
        colorColSelect.addEventListener('change', updateColorTypeOptions);
    </script>
</body>
</html>