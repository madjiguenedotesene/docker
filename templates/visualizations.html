<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation - Eurosmart Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        /* Animation pour le chargement */
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-900">

    <nav class="fixed top-0 left-0 w-full z-10 p-4 bg-gray-900/90 backdrop-blur-md shadow-md">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center z-10">
                 <img src="static/images/logo.png" alt="Logo Eurosmart Analytics" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end z-10">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 flex-grow mb-20 mt-16"> 
        <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-white text-center">Visualisation des Donn√©es</h1>
        
        <div id="selection-card" class="bg-white rounded-2xl p-6 md:p-10 shadow-2xl text-center max-w-5xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Configuration du Graphique</h2>
            <form id="plot-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="plotType" class="block text-left text-gray-700 font-bold mb-2">Type de Graphique</label>
                        <select id="plotType" name="plotType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50">
                            <option value="line">Lignes (Temporel)</option>
                            <option value="bar">Barres</option>
                            <option value="scatter">Nuage de points</option>
                            <option value="box">Bo√Æte √† moustaches</option>
                            <option value="distribution_histogram">Histogramme de distribution</option>
                            <option value="pie">Secteurs (Camembert)</option>
                        </select>
                    </div>
                    <div id="x-col-container">
                        <label for="xCol" class="block text-left text-gray-700 font-bold mb-2">Variable en X (Axe horizontal)</label>
                        <select id="xCol" name="xCol" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50"></select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div id="y-col-container" class="md:col-span-1">
                        <label for="yCol" class="block text-left text-gray-700 font-bold mb-2">Variable en Y</label>
                        <select id="yCol" name="yCol" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50"></select>
                    </div>
                    <div id="color-col-container" class="md:col-span-1">
                        <label for="colorCol" class="block text-left text-gray-700 font-bold mb-2">Colorer par</label>
                        <select id="colorCol" name="colorCol" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50"></select>
                    </div>
                    <div id="color-type-container" class="md:col-span-1">
                        <label for="colorType" class="block text-left text-gray-700 font-bold mb-2">Cat√©gorie Seuils</label>
                        <select id="colorType" name="colorType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50"></select>
                    </div>
                    <div id="city-filter-container" class="md:col-span-1">
                        <label for="city-filter" class="block text-left text-gray-700 font-bold mb-2">Filtrer Ville</label>
                        <select id="city-filter" name="city-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold rounded-lg hover:from-blue-700 hover:to-blue-900 transition-all transform hover:scale-105 shadow-lg">
                    G√©n√©rer le graphique
                </button>
            </form>
        </div>
        
        <div id="plot-card" class="bg-white rounded-2xl p-6 md:p-8 shadow-2xl text-center mt-8 hidden max-w-6xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Visualisation</h2>
            <div id="message-container" class="mt-2 text-center text-lg font-medium"></div>
            
            <div class="plot-container-wrapper w-full bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
                <div id="plot-container" class="w-full min-h-[600px]"></div>
            </div>

            <div id="analysis-trigger-container" class="mt-8 hidden">
                <button id="trigger-analysis-btn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex items-center mx-auto">
                    <span class="mr-2 text-xl">üß†</span> Lancer l'Analyse 
                </button>
            </div>

            <div id="analysis-results" class="mt-12 text-left w-full hidden space-y-8 animate-fade-in-up"></div>

            <div id="redirect-btn-container" class="p-6 md:p-10 text-center border-t border-gray-100 hidden">
                <button id="downloadPlotBtn" class="btn-gradient mt-4">üì∏ T√©l√©charger l'image</button>
                <button onclick="window.location.href='/prediction-modeling'" class="btn-gradient mt-4 ml-4">üîÆ Vers les Pr√©dictions</button>
            </div>
        </div>
    </main>

    <footer class="footer-transparent text-gray-400 p-4 mt-8 text-center">
        <div class="container mx-auto">
            <div class="flex justify-center items-center space-x-6 text-2xl mb-4">
                <a href="/" class="transform hover:scale-110 transition duration-300">‚ú® Accueil</a>
                <a href="/upload-data" class="transform hover:scale-110 transition duration-300">üìÅ Chargement</a>
                <a href="/data-preparation" class="transform hover:scale-110 transition duration-300">üßº Nettoyage</a>
                <a href="/visualizations" class="transform hover:scale-110 transition duration-300">üìà Visualisation</a>
                <a href="/prediction-modeling" class="transform hover:scale-110 transition duration-300">üîÆ Pr√©diction</a>
                <a href="/comparaison" class="transform hover:scale-110 transition duration-300">üåê Comparaison</a>
            </div>
        </div>
    </footer>

    <script>
        // --- DOM ELEMENTS ---
        const messageContainer = document.getElementById('message-container');
        const plotForm = document.getElementById('plot-form');
        const plotContainer = document.getElementById('plot-container');
        const xColSelect = document.getElementById('xCol');
        const yColSelect = document.getElementById('yCol');
        const colorColSelect = document.getElementById('colorCol');
        const colorTypeSelect = document.getElementById('colorType');
        const plotTypeSelect = document.getElementById('plotType');
        const cityFilterSelect = document.getElementById('city-filter');
        const redirectBtnContainer = document.getElementById('redirect-btn-container');
        const downloadPlotBtn = document.getElementById('downloadPlotBtn');
        const analysisBtnContainer = document.getElementById('analysis-trigger-container');
        const analysisBtn = document.getElementById('trigger-analysis-btn');
        const analysisResults = document.getElementById('analysis-results');
        
        let allColumns = []; 
        let timeColumns = []; 
        let currentPollutant = null;

        const columnTypeMapping = {
            'temp': { value: 'temperature', text: 'Temp√©rature' }, 
            'hum': { value: 'humidity', text: 'Humidit√©' }, 
            'cov': { value: 'cov', text: 'COV' },
            'iqa': { value: 'iqa', text: 'IQA' },
            'pm': { value: 'pm', text: 'Particules' },
            'co2': { value: 'co2', text: 'CO2' },
            'nox': { value: 'nox', text: 'NOx' },
            'lum': { value: 'light', text: 'Luminosit√©' }, 
        };

        // =====================================================================
        // üß† MOTEUR D'ANALYSE FRONTEND
        // =====================================================================
        const runAnalysis = async () => {
            if (!currentPollutant) return;
            
            analysisResults.classList.remove('hidden');
            analysisResults.innerHTML = `
                <div class="flex flex-col items-center justify-center p-12 bg-white rounded-2xl shadow-inner">
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-blue-600 font-semibold animate-pulse">L'IA analyse vos donn√©es ext√©rieures (Seuils, M√©t√©o)...</p>
                </div>`;
            
            try {
                const response = await fetch('/analyze_peaks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pollutant: currentPollutant })
                });
                const data = await response.json();

                if(data.error) {
                     analysisResults.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded"><p>${data.error}</p></div>`;
                     return;
                }
                
                let html = '';

                // Encyclop√©die
                if (data.knowledge && data.knowledge.desc && data.knowledge.desc !== "Aucune d√©finition encyclop√©dique disponible pour cette variable.") {
                    html += `
                        <div class="bg-white text-gray-800 rounded-[1.5rem] shadow-lg overflow-hidden border border-gray-100 mb-8 relative">
                            <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                            <div class="p-6 md:p-8">
                                <h3 class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                                    <span class="bg-blue-100 p-2 rounded-lg mr-3 text-2xl">üìö</span> Comprendre : ${data.pollutant}
                                </h3>
                                <p class="text-gray-700 text-lg mb-6 leading-relaxed">${data.knowledge.desc}</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-red-50 p-5 rounded-xl border border-red-100">
                                        <span class="font-bold text-red-600 block mb-2 text-sm uppercase tracking-wider">‚ñ≤ Facteurs de Hausse</span> 
                                        <span class="text-gray-800">${data.knowledge.hausse}</span>
                                    </div>
                                    <div class="bg-green-50 p-5 rounded-xl border border-green-100">
                                        <span class="font-bold text-green-600 block mb-2 text-sm uppercase tracking-wider">‚ñº Facteurs de Baisse</span> 
                                        <span class="text-gray-800">${data.knowledge.baisse}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }

                // Statistiques par ville
                const cities = Object.keys(data.analysis);
                if (cities.length === 0) {
                    html += `<div class="bg-yellow-50 p-6 rounded-xl text-center text-yellow-700 border border-yellow-200">‚ö†Ô∏è Pas assez de donn√©es.</div>`;
                } else {
                    cities.forEach(cityName => {
                        const cityData = data.analysis[cityName];
                        html += `
                        <div class="bg-white rounded-[1.5rem] shadow-xl overflow-hidden mb-10 border border-gray-200">
                            <div class="bg-gray-800 p-6 text-white flex flex-col md:flex-row justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">üìç</span>
                                    <h4 class="text-2xl font-bold capitalize tracking-tight">${cityName}</h4>
                                </div>
                                <div class="flex gap-4 mt-4 md:mt-0">
                                    <div class="flex flex-col items-center bg-gray-700 px-4 py-2 rounded-xl">
                                        <span class="text-gray-400 text-xs font-bold uppercase">Moyenne</span>
                                        <span class="text-lg font-mono font-bold">${cityData.stats.avg}</span>
                                    </div>
                                    <div class="flex flex-col items-center bg-red-900/60 px-4 py-2 rounded-xl">
                                        <span class="text-red-300 text-xs font-bold uppercase">Max</span>
                                        <span class="text-lg font-mono font-bold">${cityData.stats.max}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="p-6 md:p-8 bg-gray-50 grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-red-100">
                                    <h5 class="font-bold text-red-600 mb-6 flex items-center gap-2 text-lg">üìà Pics les plus hauts</h5>
                                    <div class="space-y-4">
                                        ${cityData.peaks.map(p => `
                                            <div class="flex flex-col bg-red-50/50 p-4 rounded-xl border-l-4 border-red-500">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-xs font-bold text-gray-500 uppercase bg-white px-2 py-0.5 rounded border">${data.pollutant}</span>
                                                    <span class="font-mono text-sm text-gray-500">${p.time}</span>
                                                </div>
                                                <div class="flex justify-between items-end">
                                                    <p class="text-sm text-gray-800 leading-snug w-3/4 pr-2">${p.explanation}</p>
                                                    <span class="text-2xl font-bold text-red-600">${p.value}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-green-100">
                                    <h5 class="font-bold text-green-600 mb-6 flex items-center gap-2 text-lg">üìâ Creux les plus bas</h5>
                                    <div class="space-y-4">
                                        ${cityData.troughs.map(t => `
                                            <div class="flex items-center justify-between bg-green-50/50 p-4 rounded-xl border-l-4 border-green-500">
                                                <div class="flex flex-col w-3/4">
                                                    <span class="font-mono text-sm text-gray-400 mb-1">üìÖ ${t.time}</span>
                                                    <p class="text-sm text-gray-800 leading-snug">${t.explanation}</p>
                                                </div>
                                                <span class="text-2xl font-bold text-green-600">${t.value}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                }
                analysisResults.innerHTML = html;
                analysisResults.scrollIntoView({behavior: 'smooth', block: 'start'});
            } catch (e) {
                console.error(e);
                analysisResults.innerHTML = '<p class="text-red-500 text-center">Erreur technique.</p>';
            }
        };

        analysisBtn.addEventListener('click', runAnalysis);

        // =====================================================================
        // üõ†Ô∏è INITIALISATION & GRAPHES
        // =====================================================================
        const normalizeString = (str) => str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '') : '';

        const displayMessage = (msg, type) => {
            messageContainer.textContent = (type === 'success') ? '' : msg;
            messageContainer.style.color = (type === 'error') ? '#dc2626' : '#1f2937';
        };

        const populateSelect = (select, options, includeEmpty = false, emptyText = 'S√©lectionnez...') => {
            select.innerHTML = '';
            if (includeEmpty) {
                const opt = document.createElement('option');
                opt.value = ""; opt.textContent = emptyText;
                select.appendChild(opt);
            }
            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.textContent = o;
                select.appendChild(opt);
            });
        };

        const fetchDataFrameInfo = async () => {
            try {
                const response = await fetch('/get_data_info');
                const result = await response.json();
                if (response.ok) {
                    allColumns = result.data_info.columns;
                    timeColumns = allColumns.filter(col => ['date', 'heure', 'temps'].some(k => normalizeString(col).includes(k)));
                    populateSelect(yColSelect, allColumns.filter(c => !timeColumns.includes(c)));
                    updateXColOptions();
                }
            } catch (e) {}
        };

        const updateXColOptions = () => {
            const plotType = plotTypeSelect.value;
            const isTimeSeries = ['line', 'bar'].includes(plotType);
            xColSelect.disabled = false;
            if (isTimeSeries && timeColumns.length > 0) {
                populateSelect(xColSelect, [timeColumns[0]]);
                xColSelect.disabled = true;
            } else {
                populateSelect(xColSelect, allColumns.filter(c => !timeColumns.includes(c)));
            }
            updateColorColOptions();
        };

        const updateColorColOptions = () => {
            const opts = ["", ...allColumns.filter(c => !timeColumns.includes(c))];
            populateSelect(colorColSelect, opts, false, "Aucun");
            updateColorTypeOptions();
        };

        const updateColorTypeOptions = () => {
            const col = normalizeString(colorColSelect.value);
            colorTypeSelect.innerHTML = '<option value="none">Aucun</option>';
            Object.keys(columnTypeMapping).forEach(key => {
                if(col.includes(key)) {
                    const opt = document.createElement('option');
                    opt.value = columnTypeMapping[key].value;
                    opt.textContent = columnTypeMapping[key].text;
                    colorTypeSelect.appendChild(opt);
                    colorTypeSelect.value = opt.value;
                }
            });
        };

        plotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                plotType: plotTypeSelect.value,
                xCol: xColSelect.value,
                yCol: yColSelect.value,
                colorCol: colorColSelect.value,
                colorType: colorTypeSelect.value,
                city: cityFilterSelect.value
            };
            
            document.getElementById('plot-card').classList.remove('hidden');
            analysisBtnContainer.classList.add('hidden');
            displayMessage('G√©n√©ration...', 'info');

            try {
                const res = await fetch('/generate_plot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    Plotly.newPlot('plot-container', JSON.parse(data.plot_json).data, JSON.parse(data.plot_json).layout, {responsive: true, displayModeBar: false});
                    displayMessage('', 'success');
                    redirectBtnContainer.classList.remove('hidden');
                    if (payload.yCol) { currentPollutant = payload.yCol; analysisBtnContainer.classList.remove('hidden'); }
                }
            } catch (e) {}
        });

        const fetchUniqueCities = async () => {
            try {
                const res = await fetch('/get_unique_cities');
                const data = await res.json();
                if (res.ok && data.cities) populateSelect(cityFilterSelect, data.cities, true, 'Toutes les villes');
            } catch (e) {}
        };

        document.addEventListener('DOMContentLoaded', () => { fetchDataFrameInfo(); fetchUniqueCities(); });
        plotTypeSelect.addEventListener('change', updateXColOptions);
        colorColSelect.addEventListener('change', updateColorTypeOptions);
        downloadPlotBtn.addEventListener('click', () => Plotly.downloadImage('plot-container', {format: 'png', filename: 'export'}));

    </script>
</body>
</html>