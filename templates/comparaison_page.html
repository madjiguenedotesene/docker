<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparaison M√©t√©o - PolluGard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        .loading-spinner {
            width: 20px; height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- STYLE FINAL POUR REMPLISSAGE TOTAL --- */
        .result-card {
            background: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            
            /* Flexbox Vertical */
            display: flex;
            flex-direction: column;
            
            /* Dimensions */
            height: 75vh; 
            width: 100%; 
            overflow: hidden;
            padding: 1.5rem;
        }

        .plot-wrapper {
            /* Prend tout l'espace disponible en hauteur */
            flex-grow: 1; 
            width: 100%; 
            position: relative;
            min-height: 0; /* Important pour Firefox/Flexbox */
        }

        /* Le conteneur interne de Plotly */
        .js-plotly-plot, .plot-container {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-900">

    <nav class="fixed top-0 left-0 w-full z-10 p-4 bg-gray-900/90 backdrop-blur-md shadow-md">
        <div class="container mx-auto flex justify-between items-center relative h-10">
            <a href="/" class="h-10 flex items-center z-10">
                 <img src="static/images/logo.png" alt="Logo Eurosmart Analytics" class="h-12">
            </a>
            <a href="/" class="h-10 flex items-center justify-end z-10">
                 <img src="static/images/pollugard.png" alt="Logo Pollugard" class="h-12">
            </a>
        </div>
    </nav>
 
    <main class="w-full px-4 md:px-8 lg:px-12 flex-grow mb-20 mt-16">
        
        <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-white text-center">Comparaison M√©t√©o</h1>

        <div class="main-card p-6 md:p-10 text-center bg-white rounded-2xl shadow-xl max-w-6xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Configuration</h2>
            
            <form id="comparison-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="temp-column-select" class="block text-left text-gray-700 font-bold mb-2">Temp√©rature (¬∞C)</label>
                        <select id="temp-column-select" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 text-gray-900" required disabled>
                            <option value="Temp√©rature" selected>Temp√©rature</option>
                        </select>
                    </div>
                    <div>
                        <label for="humidity-column-select" class="block text-left text-gray-700 font-bold mb-2">Humidit√© (%)</label>
                        <select id="humidity-column-select" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 text-gray-900" required disabled>
                            <option value="Humidit√©" selected>Humidit√©</option>
                        </select>
                    </div>
                    <div id="city-input-container">
                        <label for="city-input" class="block text-left text-gray-700 font-bold mb-2">Ville de r√©f√©rence</label>
                        <input type="text" id="city-input" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 text-gray-900" placeholder="Chargement..." required disabled>
                    </div>
                </div>
                
                <div class="p-6 text-center border-t border-gray-100 mt-6">
                    <button type="submit" id="submit-btn" class="btn-gradient px-8 py-3 text-lg" disabled>
                        <span id="btn-text">Lancer la Comparaison</span>
                        <span id="loading-spinner" class="loading-spinner ml-2 hidden inline-block"></span>
                    </button>
                </div>
            </form>
            <div id="message-container" class="mt-4 text-lg font-medium"></div>
        </div>

        <div id="results-container" class="hidden mt-12 space-y-12 w-full">
            
            <div class="result-card">
                <h3 class="text-2xl font-bold mb-2 text-gray-700 flex items-center justify-center gap-2 flex-none">
                    üå°Ô∏è Comparaison Temp√©rature
                </h3>
                <div class="plot-wrapper">
                    <div id="temp-plot"></div>
                </div>
            </div>

            <div class="result-card">
                <h3 class="text-2xl font-bold mb-2 text-gray-700 flex items-center justify-center gap-2 flex-none">
                    üíß Comparaison Humidit√©
                </h3>
                <div class="plot-wrapper">
                    <div id="humidity-plot"></div>
                </div>
            </div>

            <div id="action-btn-container" class="hidden">
                <div class="p-6 md:p-10 text-center border-t border-gray-100 bg-white rounded-2xl shadow-lg mt-8 max-w-6xl mx-auto">
                    <button id="downloadGraphsBtn" class="btn-gradient m-2">üì∏ T√©l√©charger les graphiques</button>
                    <a href="/" class="btn-gradient m-2 inline-block no-underline">üè† Retour Accueil</a>
                </div>
            </div>
        </div>
    </main>

   <footer class="footer-transparent text-gray-400 p-6 mt-8 text-center">
        <div class="container mx-auto flex flex-wrap justify-center gap-6">
            <a href="/" class="nav-link">‚ú® Accueil</a>
            <a href="/upload-data" class="nav-link">üìÅ Chargement</a>
            <a href="/prediction-modeling" class="nav-link">üîÆ Pr√©diction</a>
            <a href="/visualizations" class="nav-link">üìà Visualisation</a>
            <a href="/comparaison" class="nav-link">üåê Comparaison</a>
        </div>
    </footer>
    
   <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('comparison-form');
            const messageContainer = document.getElementById('message-container');
            const resultsContainer = document.getElementById('results-container');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const actionBtnContainer = document.getElementById('action-btn-container');
            const downloadGraphsBtn = document.getElementById('downloadGraphsBtn');
            const cityInputContainer = document.getElementById('city-input-container');
            const submitBtn = document.getElementById('submit-btn');

            // 1. CHARGEMENT VILLES
            fetch('/get_unique_cities')
                .then(r => r.json())
                .then(data => {
                    const cities = data.cities || [];
                    const label = cityInputContainer.querySelector('label');
                    cityInputContainer.innerHTML = ''; cityInputContainer.appendChild(label);
                    
                    let el;
                    if (cities.length > 0) {
                        el = document.createElement('select');
                        el.id = 'city-input';
                        el.className = 'w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-purple-500';
                        if (cities.length === 1) {
                            const opt = new Option(cities[0], cities[0], true, true);
                            el.add(opt);
                        } else {
                            el.add(new Option("Choisissez une ville...", "", true, true));
                            cities.forEach(c => el.add(new Option(c, c)));
                            el.options[0].disabled = true;
                        }
                    } else {
                        el = document.createElement('input');
                        el.type = 'text'; el.id = 'city-input';
                        el.className = 'w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-purple-500';
                        el.placeholder = 'Ex: Paris';
                    }
                    cityInputContainer.appendChild(el);
                    submitBtn.disabled = false;
                })
                .catch(e => console.error(e));

            // 2. SOUMISSION
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const city = document.getElementById('city-input').value;
                if (!city) { showMessage('Ville requise.', 'error'); return; }

                setLoading(true);
                
                // IMPORTANT : Ne pas cacher le container s'il est d√©j√† l√†, sinon Plotly perd ses rep√®res
                messageContainer.innerHTML = '';

                fetch('/compare_with_meteo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ temp_col: "Temp√©rature", humidity_col: "Humidit√©", city_name: city })
                })
                .then(r => r.json())
                .then(data => {
                    setLoading(false);
                    if (data.status === 'success') {
                        displayResults(data);
                    } else {
                        showMessage(data.error || data.message, 'error');
                    }
                })
                .catch(err => {
                    setLoading(false);
                    showMessage("Erreur technique.", 'error');
                });
            });

            // 3. AFFICHAGE DES R√âSULTATS (CORRECTION DU BUG D'ESPACE)
            function displayResults(data) {
                // √âTAPE A : Rendre le conteneur visible AVANT de tracer
                // Cela permet √† Plotly de lire la vraie largeur de l'√©cran (w-full)
                resultsContainer.classList.remove('hidden');
                actionBtnContainer.classList.remove('hidden');

                // Config
                const config = { responsive: true, displayModeBar: false, scrollZoom: true };
                
                // Layout Update : On force autosize et on retire les contraintes fixes
                const layoutUpdate = { 
                    autosize: true, 
                    width: null, // Tr√®s important : laisse le CSS g√©rer la largeur
                    height: null,
                    margin: { l: 60, r: 20, t: 40, b: 40 } // Marges propres
                };

                // √âTAPE B : Tracer les graphiques
                const tempData = JSON.parse(data.plots.temperature);
                Plotly.newPlot('temp-plot', tempData.data, Object.assign(tempData.layout, layoutUpdate), config);

                const humData = JSON.parse(data.plots.humidity);
                Plotly.newPlot('humidity-plot', humData.data, Object.assign(humData.layout, layoutUpdate), config);
                
                // √âTAPE C : Forcer un redimensionnement imm√©diat (Double s√©curit√©)
                // Utile si le navigateur n'avait pas fini de calculer la mise en page
                requestAnimationFrame(() => {
                    Plotly.Plots.resize('temp-plot');
                    Plotly.Plots.resize('humidity-plot');
                });

                // Scroll fluide
                setTimeout(() => resultsContainer.scrollIntoView({ behavior: 'smooth' }), 100);
            }

            downloadGraphsBtn.addEventListener('click', () => {
                Plotly.downloadImage('temp-plot', { format: 'png', filename: 'temperature_comparaison', height: 1080, width: 1920 });
                Plotly.downloadImage('humidity-plot', { format: 'png', filename: 'humidite_comparaison', height: 1080, width: 1920 });
            });

            function setLoading(isLoading) {
                if (isLoading) {
                    btnText.textContent = "Comparaison en cours...";
                    loadingSpinner.classList.remove('hidden');
                    submitBtn.disabled = true;
                } else {
                    btnText.textContent = "Lancer la Comparaison";
                    loadingSpinner.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            }

            function showMessage(msg, type) {
                messageContainer.innerHTML = `<div class="${type==='error'?'text-red-500':'text-gray-700'} font-bold">${msg}</div>`;
            }
        });
    </script>
</body>
</html>